<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Área de Administración: Gestión de incidencias (v12)</title>
  <style>
    /* Importar Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #1e293b;
      line-height: 1.6;
    }
    
    /* Header mejorado */
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #17375d 0%, #1e4d7a 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(23, 55, 93, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      opacity: 0.3;
    }
    
    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
      position: relative;
      z-index: 1;
      letter-spacing: -0.025em;
    }
    
    /* Botón volver mejorado */
    .btn-back {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(100, 116, 139, 0.3);
      margin: 1rem 0 0 1rem;
    }
    
    .btn-back:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(100, 116, 139, 0.4);
    }
    
    /* Container principal */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    /* Cards mejoradas */
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
      overflow: hidden;
      border: 1px solid rgba(226, 232, 240, 0.8);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
    }
    
    .card-header {
      background: linear-gradient(135deg, #2f75b5 0%, #1e4d7a 100%);
      color: white;
      padding: 1.5rem 2rem;
      position: relative;
      overflow: hidden;
    }
    
    .card-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
      animation: shimmer 3s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .card-header h2 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      position: relative;
      z-index: 1;
    }
    
    .card-body {
      padding: 2rem;
    }
    
    /* Botones mejorados */
    .btn {
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      font-family: inherit;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #17375d 0%, #1e4d7a 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(23, 55, 93, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(23, 55, 93, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #4f81bd 0%, #3b6aa0 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(79, 129, 189, 0.3);
    }
    
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 129, 189, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
    }
    
    .btn-edit {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }
    
    .btn-edit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
    }
    
    .btn-edit[disabled] {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: #adb5bd;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 2px 8px rgba(108, 117, 125, 0.2);
    }
    
    /* Tabla mejorada */
    .table-responsive {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }
    
    th {
      background: linear-gradient(135deg, #17375d 0%, #1e4d7a 100%);
      color: white;
      padding: 1rem;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border: none;
      white-space: nowrap;
    }
    
    td {
      padding: 1rem;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }
    
    tr:hover td {
      background-color: #f8fafc;
    }
    
    /* Enlaces mejorados */
    .link-view, .link-pdf {
      color: #2f75b5;
      text-decoration: none;
      cursor: pointer;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      background: rgba(47, 117, 181, 0.1);
      transition: all 0.3s ease;
      display: inline-block;
      margin-right: 0.5rem;
    }
    
    .link-view:hover, .link-pdf:hover {
      background: rgba(47, 117, 181, 0.2);
      transform: translateY(-1px);
    }
    
    /* Badges mejorados */
    .badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: inline-block;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .badge-pendiente {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .badge-enproceso {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    }
    
    .badge-completado {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .badge-notificado {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    
    .badge-observado {
      background: linear-gradient(135deg, red 0%, red 100%);
    }
    
    /* Filtros mejorados */
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: end;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }
    
    .filter-group label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #374151;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .filter-group input,
    .filter-group select {
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: white;
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #2f75b5;
      box-shadow: 0 0 0 3px rgba(47, 117, 181, 0.1);
    }
    
    /* Modal mejorado */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 2rem;
    }
    
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 100px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(226, 232, 240, 0.8);
    }
    
    .modal-close {
      background: transparent;
      border: none;
      font-size: 2rem;
      float: right;
      cursor: pointer;
      color: #64748b;
      transition: color 0.3s ease;
      margin-bottom: 1rem;
    }
    
    .modal-close:hover {
      color: #1e293b;
    }
    
    /* Formulario mejorado */
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #374151;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: all 0.3s ease;
      background: white;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #2f75b5;
      box-shadow: 0 0 0 3px rgba(47, 117, 181, 0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    /* Loading spinner */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      font-size: 1.1rem;
      color: #64748b;
    }
    
    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #2f75b5;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-right: 1rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .card-body {
        padding: 1.5rem;
      }
      
      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .modal-content {
        padding: 1.5rem;
        margin: 1rem;
      }
    }
    
    /* Animaciones suaves */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
      animation: fadeIn 0.6s ease-out;
    }
    
    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #17375d 0%, #2f75b5 100%);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #1e4d7a 0%, #1e4d7a 100%);
    }
  </style>
</head>
<body>
  <header>
    <h1>Área de Administración: Gestión de incidencias</h1>
  </header>

  <button class="btn-back">
    <a href="../../administracion.html" class="bi bi-arrow-left"> Volver</a>
  </button>
  
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h2>Listado de incidencias</h2>
      </div>
      <div class="card-body">
        <!-- Filtros y acciones -->
        <div class="filter-row">
          <div class="filter-group">
            <label for="filterEstadoAdmin">Filtrar por estado</label>
            <select id="filterEstadoAdmin">
              <option value="TODOS">Todos</option>
              <option value="PENDIENTE">Pendiente</option>
              <option value="EN PROCESO">En proceso</option>
              <option value="COMPLETADO">Completado</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterStartAdmin">Desde</label>
            <input type="date" id="filterStartAdmin" />
          </div>
          <div class="filter-group">
            <label for="filterEndAdmin">Hasta</label>
            <input type="date" id="filterEndAdmin" />
          </div>
          <div class="filter-group" style="margin-top:1.25rem;">
            <button id="applyFilterAdmin" class="btn btn-secondary">Aplicar filtros</button>
          </div>
          <div style="margin-left:auto; display:flex; gap:0.5rem; align-items:center;">
            <button id="exportCSV" class="btn btn-secondary">Exportar CSV</button>
            <button id="generateReportAdmin" class="btn btn-secondary">Generar reporte</button>
          </div>
        </div>
        
        <!-- Loading indicator -->
        <div id="loadingIndicator" class="loading" style="display: none;">
          <div class="spinner"></div>
          <span>Cargando datos...</span>
        </div>
        
        <div class="table-responsive">
          <table id="tablaAdmin">
            <thead>
              <tr>
                <th>N° DE<br>SOLICITUD</th>
                <th>REGISTRADO<br>POR</th>
                <th>MES</th>
                <th>ENCARGADO</th>
                <th>FECHA DE<br>EMISIÓN</th>
                <th>N°<br>PROFORMA</th>
                <th>N°<br>COMPROBANTE</th>
                <th>RESPONSABLE</th>
                <th>AREA</th>
                <th>TIPO DE<br>INCIDENCIA</th>
                <th>FECHA DE<br>CORRECCIÓN</th>
                <th>ESTADO</th>
                <th>SOLUCIÓN</th>
                <th>OBS<br>ADICIONALES</th>
                <th>MODIFICADO<br>POR</th>
                <th>COMPRA/<br>VENTA</th>
                <th>N°<br>ACTA</th>
                <th>ACCIÓN</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal detalle -->
  <div id="detailModalAdmin" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeDetailAdmin">&times;</button>
      <div id="detailContentAdmin"></div>
    </div>
  </div>
  
  <!-- Modal Actualizar Incidencia -->
  <div id="updateModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeUpdate">&times;</button>
      <h3 style="color: #17375d; font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; border-bottom: 3px solid #17375d; padding-bottom: 1rem;">Incidencia Resuelta</h3>
      <div class="form-group">
        <label for="updateSolucion">Solución</label>
        <select id="updateSolucion">
          <option value="">Seleccione...</option>
          <option value="ANULADO">ANULADO</option>
          <option value="EDITADO">EDITADO</option>
          <option value="ERROR PROFORMA">ERROR PROFORMA</option>
        </select>
      </div>
      <div class="form-group">
        <label for="updateObsAdicionales">Obs. Adicionales</label>
        <textarea id="updateObsAdicionales" placeholder="Observaciones adicionales"></textarea>
      </div>
      <div class="form-group">
        <label for="updateModificadoPor">Modificado por</label>
        <select id="updateModificadoPor">
          <option value="">Seleccione...</option>
          <option value="HERVIN">HERVIN</option>
          <option value="KIMBERLY">KIMBERLY</option>
        </select>
      </div>
      <div class="form-group">
        <label for="updateFechaCorreccion">Fecha Corrección</label>
        <input type="date" id="updateFechaCorreccion">
      </div>
      <div class="form-group">
        <label for="updateCompraVenta">Compra/Venta</label>
        <select id="updateCompraVenta">
          <option value="">Seleccione...</option>
          <option value="COMPRA">COMPRA</option>
          <option value="VENTA">VENTA</option>
          <option value="SIN INCIDENCIA">SIN INCIDENCIA</option>
        </select>
      </div>
      <div class="form-group">
        <label for="updateEstado">Estado</label>
        <select id="updateEstado">
          <option value="">Seleccione...</option>
          <option value="PENDIENTE">PENDIENTE</option>
          <option value="EN PROCESO">EN PROCESO</option>
          <option value="NOTIFICADO">NOTIFICADO</option>
          <option value="COMPLETADO">COMPLETADO</option>
          <option value="OBSERVADO">OBSERVADO</option>
        </select>
      </div>
      <div class="form-group">
        <label for="updateNumeroActa">N° Acta</label>
        <input type="text" id="updateNumeroActa" placeholder="Número de acta">
      </div>
      <div style="text-align: right; margin-top: 2rem;">
        <button id="saveUpdate" class="btn btn-primary">Guardar cambios</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Configuración de la API
    const API_BASE_URL = "https://incidenciaslogisticaproformas-2946605267.us-central1.run.app";
    
    // Datos de la API
    let apiData = [];
    
    // Función para convertir número de mes a nombre
    function getMonthName(monthNumber) {
      const months = [
        'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
      ];
      return months[monthNumber - 1] || '';
    }
    
    // Función para convertir fecha de MySQL a formato dd/mm/yyyy
    function formatDate(dateString) {
      if (!dateString) return '';
      
      // Si ya está en formato dd/mm/yyyy, retornarlo tal como está
      if (dateString.includes('/')) return dateString;
      
      // Convertir de formato MySQL (YYYY-MM-DD) a dd/mm/yyyy
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString; // Si no es una fecha válida, retornar el string original
      
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      
      return `${day}/${month}/${year}`;
    }
    
    // Función para convertir fecha de dd/mm/yyyy a formato MySQL
    function formatDateToMySQL(dateString) {
      if (!dateString) return '';
      
      // Si ya está en formato MySQL, retornarlo tal como está
      if (dateString.includes('-')) return dateString;
      
      // Convertir de formato dd/mm/yyyy a MySQL (YYYY-MM-DD)
      const parts = dateString.split('/');
      if (parts.length !== 3) return dateString;
      
      const day = parts[0];
      const month = parts[1];
      const year = parts[2];
      
      return `${year}-${month}-${day}`;
    }
    
    // Función para obtener datos de la API
    async function fetchData() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const tableBody = document.querySelector('#tablaAdmin tbody');
      
      try {
        loadingIndicator.style.display = 'flex';
        tableBody.innerHTML = '';
        
        const params = { tipo: "listado" };
        const headers = { "Content-Type": "application/json" };
        
        const url = new URL(API_BASE_URL);
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
        
        const response = await fetch(url, {
          method: 'GET',
          headers: headers
        });
        
        if (response.status === 200) {
          console.log("Datos extraídos correctamente");
          apiData = await response.json();
          renderTable();
        } else {
          console.error("Error al extraer los datos");
          throw new Error(`HTTP error! status: ${response.status}`);
        }
      } catch (error) {
        console.error("Error al obtener datos:", error);
        tableBody.innerHTML = '<tr><td colspan="15" style="text-align: center; color: #dc2626; padding: 2rem;">Error al cargar los datos. Por favor, intente nuevamente.</td></tr>';
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }
    
    // Obtener clase de badge según estado
    function badgeClass(val) {
      const v = (val || '').toUpperCase();
      if (v === 'PENDIENTE') return 'badge-pendiente';
      if (v === 'EN PROCESO') return 'badge-enproceso';
      if (v === 'NOTIFICADO') return 'badge-notificado';
      if (v === 'COMPLETADO') return 'badge-completado';
      if (v === 'OBSERVADO') return 'badge-observado';
      return '';
    }
    
    // Renderizar tabla
    function renderTable() {
      const tbody = document.querySelector('#tablaAdmin tbody');
      tbody.innerHTML = '';
      
      const estadoFiltro = document.getElementById('filterEstadoAdmin').value;
      const start = document.getElementById('filterStartAdmin').value;
      const end = document.getElementById('filterEndAdmin').value;
      
      apiData.forEach((rec, idx) => {
        const estado = rec['ESTADO_INCIDENCIA'] || '';
        
        // Filtrar por estado
        if (estadoFiltro !== 'TODOS' && estado.toUpperCase() !== estadoFiltro) return;
        
        // Filtrar por fecha
        if (start) {
          const fecha = (rec['FECHA_EMISION'] || '').substring(0, 10);
          if (!fecha || fecha < start) return;
        }
        if (end) {
          const fecha = (rec['FECHA_EMISION'] || '').substring(0, 10);
          if (!fecha || fecha > end) return;
        }
        
        const tr = document.createElement('tr');
        const cells = [
          rec['ID'] || idx + 1,
          rec['REGISTRADO_POR'] || '',
          getMonthName(rec['MONTH(FECHA_EMISION)'] || ''),
          rec['ENCARGADO_COMPROBANTE'] || '',
          formatDate(rec['DATE(FECHA_EMISION)'] || rec['FECHA_EMISION'] || ''),
          rec['NUMERO_PROFORMA'] || '',
          rec['NUMERO_COMPROBANTE'] || '',
          rec['RESPONSABLE_INCIDENCIA'] || '',
          rec['AREA'] || '',
          rec['TIPO_INCIDENCIA'] || '',
          rec['FECHA_CORRECION'] || '',
          '<span class="badge ' + badgeClass(estado) + '">' + (estado || '') + '</span>',
          rec['SOLUCION'] || '',
          rec['OBSERVACION_ADICIONAL_CORRECION'] || '',
          rec['MODIFICADO_POR'] || '',
          rec['COMPRA_VENTA'] || '',
          rec['NUMERO_ACTA'] || '',
          '<button class="btn btn-edit" data-index="' + idx + '">Actualizar</button>'
        ];
        
        cells.forEach((html) => {
          const td = document.createElement('td');
          td.innerHTML = html;
          tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
      });
      
      // Agregar eventos a botones de actualizar
      document.querySelectorAll('.btn-edit').forEach((btn) => {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          const i = parseInt(this.dataset.index);
          openUpdateModal(i);
        });
      });
    }
    
    // Mostrar detalles en modal
    function showDetail(index) {
      const rec = apiData[index];
      const container = document.getElementById('detailContentAdmin');
      container.innerHTML = '';
      
      const fields = [
        ['N° DE SOLICITUD', rec['ID'] || ''],
        ['Registrado por', rec['REGISTRADO_POR'] || ''],
        ['Mes', getMonthName(rec['MONTH(FECHA_EMISION)'] || '')],
        ['Encargado', rec['ENCARGADO_COMPROBANTE'] || ''],
        ['Fecha de emisión', formatDate(rec['DATE(FECHA_EMISION)'] || rec['FECHA_EMISION'] || '')],
        ['N° de proforma', rec['NUMERO_PROFORMA'] || ''],
        ['N° de comprobante', rec['NUMERO_COMPROBANTE'] || ''],
        ['Responsable', rec['RESPONSABLE_INCIDENCIA'] || ''],
        ['Área', rec['AREA'] || ''],
        ['Tipo de incidencia', rec['TIPO_INCIDENCIA'] || ''],
        ['Fecha de corrección', rec['FECHA_CORRECION'] || ''],
        ['Estado', rec['ESTADO_INCIDENCIA'] || ''],
        ['Solución', rec['SOLUCION'] || ''],
        ['Observaciones adicionales', rec['OBSERVACION_ADICIONAL_CORRECION'] || ''],
        ['Modificado por', rec['MODIFICADO_POR'] || ''],
        ['Compra/Venta', rec['COMPRA_VENTA'] || ''],
        ['N° Acta', rec['NUMERO_ACTA'] || '']
      ];
      
      fields.forEach(([label, value]) => {
        const p = document.createElement('p');
        p.innerHTML = '<strong>' + label + ':</strong> ' + (value || '');
        container.appendChild(p);
      });
      
      document.getElementById('detailModalAdmin').style.display = 'flex';
    }
    
    // Variables para actualizar
    let currentUpdateIndex = null;
    
    // Función para abrir modal de actualización
    function openUpdateModal(index) {
      currentUpdateIndex = index;
      const rec = apiData[index];
      
      // Llenar el modal con datos existentes
      document.getElementById('updateSolucion').value = rec['SOLUCION'] || '';
      document.getElementById('updateObsAdicionales').value = rec['OBSERVACION_ADICIONAL_CORRECION'] || '';
      document.getElementById('updateModificadoPor').value = rec['MODIFICADO_POR'] || '';
      document.getElementById('updateFechaCorreccion').value = rec['FECHA_CORRECION'] ? rec['FECHA_CORRECION'].substring(0, 10) : '';
      document.getElementById('updateCompraVenta').value = rec['COMPRA_VENTA'] || '';
      document.getElementById('updateEstado').value = rec['ESTADO_INCIDENCIA'] || '';
      document.getElementById('updateNumeroActa').value = rec['NUMERO_ACTA'] || '';
      
      document.getElementById('updateModal').style.display = 'flex';
    }
    
    // Generar PDF
    function generatePDF(index) {
      const rec = apiData[index];
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      
      doc.setFontSize(14);
      doc.text('Detalle de Incidencia', 105, y, { align: 'center' });
      y += 10;
      doc.setFontSize(10);
      
      const entries = [
        ['N° DE SOLICITUD', rec['ID'] || ''],
        ['Registrado por', rec['REGISTRADO_POR'] || ''],
        ['Mes', getMonthName(rec['MONTH(FECHA_EMISION)'] || '')],
        ['Encargado', rec['ENCARGADO_COMPROBANTE'] || ''],
        ['Fecha de emisión', formatDate(rec['DATE(FECHA_EMISION)'] || rec['FECHA_EMISION'] || '')],
        ['N° de proforma', rec['NUMERO_PROFORMA'] || ''],
        ['N° de comprobante', rec['NUMERO_COMPROBANTE'] || ''],
        ['Responsable', rec['RESPONSABLE_INCIDENCIA'] || ''],
        ['Área', rec['AREA'] || ''],
        ['Tipo de incidencia', rec['TIPO_INCIDENCIA'] || ''],
        ['Fecha de corrección', rec['FECHA_CORRECION'] || ''],
        ['Estado', rec['ESTADO_INCIDENCIA'] || ''],
        ['Solución', rec['SOLUCION'] || ''],
        ['Observaciones adicionales', rec['OBSERVACION_ADICIONAL_CORRECION'] || ''],
        ['Modificado por', rec['MODIFICADO_POR'] || ''],
        ['Compra/Venta', rec['COMPRA_VENTA'] || ''],
        ['N° Acta', rec['NUMERO_ACTA'] || '']
      ];
      
      entries.forEach(([label, value]) => {
        doc.text(`${label}: ${value || ''}`, 10, y);
        y += 6;
      });
      
      doc.save(`incidencia_${rec['NUMERO_PROFORMA'] || 'detalle'}.pdf`);
    }
    
    // Genera un informe PDF de todas las incidencias registradas según el filtro actual
    function generateReportAdmin() {
      const table = document.querySelector('#tablaAdmin');
      if (!table) return;
      
      html2canvas(table).then((canvas) => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'pt', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const imgWidth = pageWidth - 20;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        const finalHeight = imgHeight > pageHeight - 20 ? pageHeight - 20 : imgHeight;
        const finalWidth = imgHeight > pageHeight - 20 ? (canvas.width * finalHeight / canvas.height) : imgWidth;
        const x = (pageWidth - finalWidth) / 2;
        const y = 10;
        
        doc.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
        doc.save('reporte_incidencias_admin.pdf');
      });
    }
    
    // Exportar CSV
    function exportCSV() {
      let csv = 'N° DE SOLICITUD,REGISTRADO POR,MES,ENCARGADO,FECHA DE EMISIÓN,N° PROFORMA,N° COMPROBANTE,RESPONSABLE,AREA,TIPO DE INCIDENCIA,FECHA DE CORRECCIÓN,ESTADO,SOLUCIÓN,OBS ADICIONALES,MODIFICADO POR,COMPRA/VENTA,N° ACTA\n';
      
      apiData.forEach((rec) => {
        const row = [
          rec['ID'] || '',
          rec['REGISTRADO_POR'] || '',
          getMonthName(rec['MONTH(FECHA_EMISION)'] || ''),
          rec['ENCARGADO_COMPROBANTE'] || '',
          formatDate(rec['DATE(FECHA_EMISION)'] || rec['FECHA_EMISION'] || ''),
          rec['NUMERO_PROFORMA'] || '',
          rec['NUMERO_COMPROBANTE'] || '',
          rec['RESPONSABLE_INCIDENCIA'] || '',
          rec['AREA'] || '',
          rec['TIPO_INCIDENCIA'] || '',
          rec['FECHA_CORRECION'] || '',
          rec['ESTADO_INCIDENCIA'] || '',
          rec['SOLUCION'] || '',
          rec['OBSERVACION_ADICIONAL_CORRECION'] || '',
          rec['MODIFICADO_POR'] || '',
          rec['COMPRA_VENTA'] || '',
          rec['NUMERO_ACTA'] || ''
        ];
        csv += row.map((x) => '"' + (x || '').replace(/"/g, '""') + '"').join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'incidencias_admin.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // Event listeners
    document.getElementById('closeDetailAdmin').addEventListener('click', () => {
      document.getElementById('detailModalAdmin').style.display = 'none';
    });
    
    document.getElementById('closeUpdate').addEventListener('click', () => {
      document.getElementById('updateModal').style.display = 'none';
    });
    
    document.getElementById('saveUpdate').addEventListener('click', async () => {
      if (currentUpdateIndex === null) return;
      
      const rec = apiData[currentUpdateIndex];
      
      // Obtener valores del modal
      const solucion = document.getElementById('updateSolucion').value;
      const obsAdicionales = document.getElementById('updateObsAdicionales').value;
      const modificadoPor = document.getElementById('updateModificadoPor').value;
      const fechaCorreccion = document.getElementById('updateFechaCorreccion').value;
      const compraVenta = document.getElementById('updateCompraVenta').value;
      const estado = document.getElementById('updateEstado').value;
      const numeroActa = document.getElementById('updateNumeroActa').value;
      
      // Validar campos obligatorios
      if (!solucion.trim() || !modificadoPor.trim() || !fechaCorreccion || !compraVenta || !estado) {
        alert('Por favor, complete todos los campos obligatorios: Solución, Modificado por, Fecha de corrección, Compra/Venta y Estado');
        return;
      }
      
      try {
        // Crear fecha y hora actual en formato datetime
        const now = new Date();
        const fechaHoraActual = now.getFullYear() + '-' + 
                               String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(now.getDate()).padStart(2, '0') + ' ' + 
                               String(now.getHours()).padStart(2, '0') + ':' + 
                               String(now.getMinutes()).padStart(2, '0') + ':' + 
                               String(now.getSeconds()).padStart(2, '0');
        
        // Preparar payload para la API
        const payload = {
          id: parseInt(rec['ID']),
          obs_adicionales: obsAdicionales,
          solucion: solucion,
          modificado_por: modificadoPor,
          fecha_correcion: fechaHoraActual,
          compra_venta: compraVenta,
          estado_incidencia: estado,
          numero_acta: numeroActa
        };
        
        const headers = { "Content-Type": "application/json" };
        
        // Llamar a la API para actualizar
        const response = await fetch(API_BASE_URL, {
          method: 'PUT',
          headers: headers,
          body: JSON.stringify(payload)
        });
        
        if (response.status === 200) {
          console.log("Actualizado correctamente");
          
          // Actualizar el registro local
          rec['SOLUCION'] = solucion;
          rec['OBSERVACION_ADICIONAL_CORRECION'] = obsAdicionales;
          rec['MODIFICADO_POR'] = modificadoPor;
          rec['FECHA_CORRECION'] = payload.fecha_correcion;
          rec['COMPRA_VENTA'] = compraVenta;
          rec['ESTADO_INCIDENCIA'] = estado;
          rec['NUMERO_ACTA'] = numeroActa;
          
          // Si se completó la solución, cambiar estado a COMPLETADO
          if (solucion.trim() && fechaCorreccion) {
            rec['ESTADO_INCIDENCIA'] = 'COMPLETADO';
          } else if (solucion.trim()) {
            rec['ESTADO_INCIDENCIA'] = 'EN PROCESO';
          }
          
          // Cerrar modal y actualizar tabla
          document.getElementById('updateModal').style.display = 'none';
          renderTable();
          
          // Mostrar mensaje de éxito
          alert('Incidencia actualizada correctamente');
        } else {
          console.error("Datos no actualizados");
          const errorText = await response.text();
          console.error(errorText);
          alert('Error al actualizar la incidencia. Por favor, intente nuevamente.');
        }
      } catch (error) {
        console.error("Error al actualizar:", error);
        alert('Error de conexión al actualizar la incidencia. Por favor, intente nuevamente.');
      }
    });
    
    document.getElementById('exportCSV').addEventListener('click', exportCSV);
    
    document.getElementById('applyFilterAdmin').addEventListener('click', () => {
      renderTable();
    });
    
    document.getElementById('generateReportAdmin').addEventListener('click', generateReportAdmin);
    
    // Inicializar
    window.addEventListener('load', fetchData);
  </script>
</body>
</html>
