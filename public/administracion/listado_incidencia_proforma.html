<!DOCTYPE html>
<!-- alias: administracion2025originalzeus | módulo: administración | STORAGE_KEY=incidencias_v12 -->
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Área de Administración: Listado de incidencias y actas</title>
  <style>
    :root{ --azul:#0056D2; --azul-oscuro:#17375d; --negro:#000; --gris:#f5f5f5; --rojo:#c00000; --verde:#00B140; --link:#0056D2; --celeste:#17a2b8; --naranja:#ff9800; --amarillo:#ffc107; }
    body{ font-family:Arial, sans-serif; margin:0; background:#fff; color:#000; }
    header.titulo-principal{ background:#0056D2; color:#fff; font-weight:bold; padding:10px 15px; border-radius:5px 5px 0 0; }
    .container{ max-width:1400px; margin:0 auto; padding:1rem; }
    .card{ background:#fff; border-radius:8px; box-shadow:0 6px 18px rgba(18,38,63,.08); margin-bottom:1.25rem; overflow:hidden; }
    .card-header{ background:#0056D2; color:#fff; padding:.75rem 1rem; display:flex; align-items:center; justify-content:space-between; }
    .card-header h2{ margin:0; font-size:1.05rem; }
    .card-body{ padding:1rem; }

    .filter-row{ display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end; margin-bottom:.75rem; }
    .filter-group{ display:flex; flex-direction:column; font-size:.85rem; min-width:180px; }
    .filter-actions{ margin-left:auto; display:flex; gap:.5rem; align-items:center; }

    .btn{ padding:.45rem .8rem; border:none; border-radius:6px; cursor:pointer; font-size:.85rem; }
    .btn-azul{ background:#0056D2; color:#fff; }
    .btn-azul:hover{ filter:brightness(.92); }
    .btn-ghost{ background:transparent; border:1px solid #ddd; }
    .btn-outline-light{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,.75); border-radius:6px; padding:6px 12px; font-weight:600; display:inline-flex; align-items:center; gap:.35rem; }
    .btn-outline-light:hover{ background:rgba(255,255,255,.12); border-color:#fff; }
    .btn-ok{ background:#00B140; color:#fff; }
    .btn-danger{ background:#c00000; color:#fff; }

    .table-responsive{ overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    thead th{ background:#000; color:#fff; text-align:center; padding:8px; position:sticky; top:0; z-index:1; }
    th,td{ border:1px solid #e7e7e7; font-size:.85rem; vertical-align:top; padding:.55rem; }
    td a{ color:var(--link); text-decoration:none; cursor:pointer; }
    .cell-actions{ display:flex; gap:.5rem; align-items:center; }
    .nowrap{ white-space:nowrap; }

    .badge{ padding:.2rem .5rem; border-radius:.25rem; color:#fff; font-size:.75rem; display:inline-block; }
    .badge-pendiente{ background:var(--amarillo); color:#000; }
    .badge-enrevision{ background:var(--naranja); }
    .badge-notificado{ background:var(--celeste); }
    .badge-completado{ background:#4caf50; }
    .badge-observado{ background:#c00000; }

    /* Ítems (col 9) centrado, sin subrayado */
    #tablaAdmin th:nth-child(9), #tablaAdmin td:nth-child(9){ text-align:center; white-space:nowrap; }
    /* Tipo (col 12) ancho y centrado */
    #tablaAdmin th:nth-child(12), #tablaAdmin td:nth-child(12){ min-width:160px; white-space:nowrap; text-align:center; }
    /* Solución (col 14) centrado */
    #tablaAdmin th:nth-child(14), #tablaAdmin td:nth-child(14){ text-align:center; }
    /* Obs (col 15) centrado */
    #tablaAdmin th:nth-child(15), #tablaAdmin td:nth-child(15){ text-align:center; }
    /* Revisado por (col 16) centrado y mayúsculas */
    #tablaAdmin th:nth-child(16), #tablaAdmin td:nth-child(16){ text-align:center; text-transform:uppercase; }
    /* Comprobante (col 22) centrado y mayúsculas */
    #tablaAdmin th:nth-child(22), #tablaAdmin td:nth-child(22){ text-align:center; text-transform:uppercase; }
    /* N° comp fact (col 23) centrado */
    #tablaAdmin th:nth-child(23), #tablaAdmin td:nth-child(23){ text-align:center; }

    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; justify-content:center; align-items:flex-start; padding-top:5%; z-index:1000; }
    .modal-content{ background:#fff; padding:1rem; border-radius:8px; width:92%; max-width:640px; max-height:80vh; overflow-y:auto; box-shadow:0 12px 32px rgba(0,0,0,.25); }
    .modal-close{ background:transparent; border:none; font-size:1.5rem; float:right; cursor:pointer; }
    .form-group{ display:flex; flex-direction:column; margin-bottom:.75rem; }
    .form-group label{ font-weight:bold; margin-bottom:.25rem; }
    .form-group input,.form-group select,.form-group textarea{ padding:.5rem; border:1px solid #ccc; border-radius:6px; font-size:.9rem; }
    .muted{ color:#6b7280; font-size:.85rem; }
    .prelike{ white-space:pre-wrap; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; padding:.5rem; }
  </style>
</head>
<body>
  <header class="titulo-principal">Área de Administración: Listado de incidencias y actas</header>

  <div class="container">
    <div class="card">
      <div class="card-header">
        <h2>Listado de incidencias</h2>
        <button type="button" id="btnProcedimiento" class="btn btn-outline-light" title="Ver procedimiento">
          <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M20 22V6a2 2 0 0 0-2-2H6.5A2.5 2.5 0 0 0 4 6.5v13"/><path d="M8 6v12"/><path d="M12 6v12"/><path d="M16 6v12"/></svg>
          Ver procedimiento
        </button>
      </div>
      <div class="card-body">
        <div class="filter-row">
          <div class="filter-group">
            <label for="filterEstado">Filtrar por verificación</label>
            <select id="filterEstado">
              <option value="TODOS">Todos</option>
              <option value="PENDIENTE">Pendiente</option>
              <option value="EN REVISIÓN">En revisión</option>
              <option value="NOTIFICADO">Notificado</option>
              <option value="COMPLETADO">Completado</option>
              <option value="OBSERVADO">Observado</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterStart">Desde</label>
            <input type="date" id="filterStart" />
          </div>
          <div class="filter-group">
            <label for="filterEnd">Hasta</label>
            <input type="date" id="filterEnd" />
          </div>
          <div class="filter-actions">
            <button id="applyFilter" class="btn btn-azul">Aplicar filtros</button>
            <button id="clearFilters" class="btn btn-ghost">Limpiar</button>
            <button id="exportCSV" class="btn btn-azul">Exportar CSV</button>
            <button id="generateReport" class="btn btn-azul">Generar reporte</button>
          </div>
        </div>

        <div class="table-responsive" id="tableViewport">
          <table id="tablaAdmin">
            <thead>
              <tr>
                <th>ID</th>
                <th>Fecha de registro</th>
                <th>Registrado por</th>
                <th>Mes</th>
                <th>Encargado comprobante</th>
                <th>Fecha emisión</th>
                <th>N° proforma/acta</th>
                <th>N° comprobante</th>
                <th>Ítems de error</th>
                <th>Responsable</th>
                <th>Área</th>
                <th>Tipo de incidencia</th>
                <th>Fecha de notificación</th>
                <th>Solución</th>
                <th>Obs. adicionales</th>
                <th>Revisado por</th>
                <th>Estado de verificación</th>
                <th>Fecha envío de archivo</th>
                <th>Archivo de solución</th>
                <th>Fecha de corrección</th>
                <th>Estado de la solución</th>
                <th>Comprobante</th>
                <th>N° de comprobante (Fact.)</th>
                <th>Culminado</th>
                <th>Fecha concluyente</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modales básicos -->
  <div id="detailModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeDetail" aria-label="Cerrar">&times;</button>
      <div id="detailContent"></div>
    </div>
  </div>
  <div id="viewTextModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeViewText" aria-label="Cerrar">&times;</button>
      <h3 style="margin-top:0">Archivo de solución — texto/enlace</h3>
      <div id="viewArchivoContent"></div>
    </div>
  </div>
  <div id="obsModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeObs" aria-label="Cerrar">&times;</button>
      <h3 style="margin-top:0">Observaciones adicionales</h3>
      <div id="obsContent" class="prelike"></div>
    </div>
  </div>
  <div id="procedimientoModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeProcedimiento" aria-label="Cerrar">&times;</button>
      <h3 style="margin-top:0">Procedimiento</h3>
      <div class="prelike">1) Paso inicial\n2) Paso intermedio\n3) Paso final</div>
    </div>
  </div>
  <div id="verifModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeVerif" aria-label="Cerrar">&times;</button>
      <h3 style="margin-top:0">Actualizar verificación</h3>
      <p class="muted">La <strong>Fecha de notificación</strong> se registrará automáticamente al guardar.</p>
      <div class="form-group">
        <label for="vSolucion">Solución</label>
        <select id="vSolucion">
          <option value="">Seleccione...</option>
          <option>ANULADO</option>
          <option>MODIFICADO</option>
          <option>UNA COMPRA</option>
          <option>UNA VENTA</option>
          <option>SIN INCIDENCIA</option>
        </select>
      </div>
      <div class="form-group">
        <label for="vObs">Obs. adicionales</label>
        <textarea id="vObs" rows="3" placeholder="Escriba observaciones"></textarea>
      </div>
      <div class="form-group">
        <label for="vRevisado">Revisado por</label>
        <select id="vRevisado">
          <option value="">Seleccione...</option>
          <option>KIMBERLY</option>
          <option>HERVIN</option>
        </select>
      </div>
      <div class="form-group">
        <label for="vEstado">Estado de verificación</label>
        <select id="vEstado">
          <option>PENDIENTE</option>
          <option>EN REVISIÓN</option>
          <option>NOTIFICADO</option>
          <option>COMPLETADO</option>
          <option>OBSERVADO</option>
        </select>
      </div>
      <div class="cell-actions"><button class="btn btn-ok" id="vSave">Guardar</button><button class="btn btn-ghost" id="vCancel">Cancelar</button></div>
    </div>
  </div>
  <div id="culmModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeCulm" aria-label="Cerrar">&times;</button>
      <h3 style="margin-top:0">Actualizar culminado</h3>
      <div class="form-group">
        <label>Estado</label>
        <div>
          <label><input type="radio" name="culmState" value="SI"> Sí</label>
          &nbsp;&nbsp;
          <label><input type="radio" name="culmState" value="NO" checked> No</label>
        </div>
      </div>
      <p class="muted">Fecha concluyente: <strong>se registrará automáticamente al guardar (12h AM/PM)</strong>.</p>
      <div class="cell-actions"><button class="btn btn-ok" id="culmSave">Guardar</button><button class="btn btn-ghost" id="culmCancel">Cancelar</button></div>
    </div>
  </div>

  <!-- Libs primero, luego nuestro script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // ====== Storage ======
    const STORAGE_KEY='incidencias_v12';
    const loadStored=()=>{ try{const s=localStorage.getItem(STORAGE_KEY); return s?JSON.parse(s):[];}catch{ localStorage.removeItem(STORAGE_KEY); return [];} };
    const saveStored=(d)=>localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
    const getAllRecords=()=>[...loadStored()];
    const findById=(id)=>getAllRecords().find(r=>r && r.ID===id)||null;
    const upsertStoredById=(rec)=>{ const s=loadStored(); const i=s.findIndex(r=>r&&r.ID===rec.ID); if(i===-1) s.unshift(rec); else s[i]=rec; saveStored(s); };

    // ====== Fechas ======
    const fmtDateDisplay=(dt)=>{ if(!dt) return ''; const d=new Date(dt); if(isNaN(d)) return dt; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); let hh=d.getHours(); const ap=hh>=12?'PM':'AM'; hh=hh%12||12; const mi=String(d.getMinutes()).padStart(2,'0'); const ss=String(d.getSeconds()).padStart(2,'0'); return `${dd}-${mm}-${yyyy} ${String(hh).padStart(2,'0')}:${mi}:${ss} ${ap}`; };
    const fmtDateOnly=(dt)=>{ if(!dt) return ''; const d=new Date(dt); if(isNaN(d)) return dt; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); return `${dd}/${mm}/${yyyy}`; };
    const nowLocalISO=()=>{ const d=new Date(); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); const HH=String(d.getHours()).padStart(2,'0'); const MI=String(d.getMinutes()).padStart(2,'0'); const SS=String(d.getSeconds()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}T${HH}:${MI}:${SS}`; };

    // ====== Badges ======
    const badgeClass=(v)=>{ const s=(v||'').toUpperCase(); if(s==='PENDIENTE')return'badge-pendiente'; if(s==='EN REVISIÓN'||s==='EN REVISION'||s==='EN PROCESO')return'badge-enrevision'; if(s==='NOTIFICADO')return'badge-notificado'; if(s==='COMPLETADO')return'badge-completado'; if(s==='OBSERVADO')return'badge-observado'; return''; };

    // ====== Helpers de celda ======
    const tdText=(t)=>{ const td=document.createElement('td'); td.textContent=t==null?'':String(t); return td; };
    const tdHTML=(n)=>{ const td=document.createElement('td'); td.appendChild(n); return td; };
    const spanNowrap=(t)=>{ const s=document.createElement('span'); s.className='nowrap'; s.textContent=t||''; return s; };

    const itemsCell=(rec)=>{ const td=document.createElement('td'); const arr=rec['ITEMS']; const ok=Array.isArray(arr)&&arr.length>0; if(!ok){ td.textContent='Sin ítems'; return td; } const eye=document.createElement('a'); eye.href='#'; eye.textContent='👁️'; eye.dataset.action='view'; eye.dataset.id=rec.ID; const pdf=document.createElement('a'); pdf.href='#'; pdf.textContent='PDF'; pdf.dataset.action='pdf'; pdf.dataset.id=rec.ID; td.append(eye, document.createTextNode(' '), pdf); return td; };

    const archivoCellReadOnly=(rec)=>{ const td=document.createElement('td'); const box=document.createElement('div'); box.className='cell-actions'; const hasText=!!(rec['ARCHIVO SOLUCION TEXTO'] && String(rec['ARCHIVO SOLUCION TEXTO']).trim()); const hasPdf=!!rec['ARCHIVO SOLUCION DATAURL']; if(hasText){ const a=document.createElement('a'); a.href='#'; a.textContent='Ver'; a.dataset.action='view-text'; a.dataset.id=rec.ID; box.appendChild(a);} if(hasPdf){ if(box.children.length) box.appendChild(document.createTextNode(' / ')); const a=document.createElement('a'); a.href=rec['ARCHIVO SOLUCION DATAURL']; a.setAttribute('download', rec['ARCHIVO SOLUCION NOMBRE']||'archivo.pdf'); a.textContent='PDF'; box.appendChild(a);} if(!box.children.length){ box.appendChild(document.createTextNode('—')); } td.appendChild(box); return td; };

    const estadoCell=(rec)=>{ const td=document.createElement('td'); const box=document.createElement('div'); box.className='cell-actions'; const estado=(rec['ESTADO VERIFICACION']||'').toString(); const badge=document.createElement('span'); badge.className=`badge ${badgeClass(estado)}`; badge.textContent=(estado||'').toUpperCase(); const btn=document.createElement('button'); btn.className=( (estado||'').toUpperCase()==='PENDIENTE' ? 'btn btn-danger' : 'btn btn-ok'); btn.textContent='Editar'; btn.dataset.action='edit-verif'; btn.dataset.id=rec.ID; box.append(badge, btn); td.appendChild(box); return td; };

    const culminadoCell=(rec)=>{ const td=document.createElement('td'); const box=document.createElement('div'); box.className='cell-actions'; const val=(rec['CULMINADO']||'NO').toUpperCase()==='SI'; const badge=document.createElement('span'); badge.className=`badge ${val? 'badge-completado':'badge-observado'}`; badge.textContent=val?'Sí':'No'; const btn=document.createElement('button'); btn.className=val?'btn btn-ok':'btn btn-danger'; btn.textContent='Editar'; btn.dataset.action='edit-culm'; btn.dataset.id=rec.ID; box.append(badge, btn); td.appendChild(box); return td; };

    // ====== Filtros & render ======
    const filterRecords=()=>{ const estadoSel=document.getElementById('filterEstado')?.value||'TODOS'; const start=document.getElementById('filterStart')?.value||''; const end=document.getElementById('filterEnd')?.value||''; return getAllRecords().filter(rec=>{ const est=(rec['ESTADO VERIFICACION']||'PENDIENTE').toString().toUpperCase(); if(estadoSel!=='TODOS' && est!==estadoSel) return false; const fISO=rec['FECHA DE EMISION']||''; const f=typeof fISO==='string'? fISO.substring(0,10):''; if(start && (!f||f<start)) return false; if(end && (!f||f>end)) return false; return true; }); };

    const renderList=()=>{ const tbody=document.querySelector('#tablaAdmin tbody'); tbody.innerHTML=''; filterRecords().forEach(rec=>{ const tr=document.createElement('tr'); tr.appendChild(tdText(rec['ID']||'')); tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['FECHA REGISTRO'])||''))); tr.appendChild(tdText(rec['REGISTRADO POR']||'')); tr.appendChild(tdText(rec['MES']||'')); tr.appendChild(tdText(rec['ENCARGADO DE LA VENTA']||rec['ENCARGADO DE COMPROBANTE']||'')); tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['FECHA DE EMISION'])||''))); tr.appendChild(tdText(rec['N° DE PROFORMA']||rec['N° PROFORMA O ACTA']||'')); tr.appendChild(tdText(rec['N° DE COMPROBANTE']||'')); tr.appendChild(itemsCell(rec)); tr.appendChild(tdText(rec['RESPONSABLE']||'')); tr.appendChild(tdText(rec['AREA']||'')); const tipo=(rec['OBSERVACIONES']||rec['TIPO DE INCIDENCIA']||''); tr.appendChild(tdText(tipo?String(tipo).toUpperCase():'')); tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['FECHA NOTIFICACION'])||''))); tr.appendChild(tdHTML(spanNowrap((rec['SOLUCION']||'').toString().toUpperCase()))); const obsTd=document.createElement('td'); const txt=(rec['OBSERVACIONES_ADMIN']||'').trim(); if(txt){ const a=document.createElement('a'); a.href='#'; a.textContent='👁️'; a.dataset.action='view-obs'; a.dataset.id=rec.ID; obsTd.style.textAlign='center'; obsTd.appendChild(a);} else obsTd.textContent='—'; tr.appendChild(obsTd); tr.appendChild(tdText((rec['REVISADO POR']||'').toString().toUpperCase())); tr.appendChild(estadoCell(rec)); tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['FECHA ENVIO ARCHIVO'])||''))); tr.appendChild(archivoCellReadOnly(rec)); tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['FACTURACION FECHA CORRECCION'])||''))); tr.appendChild(tdText(rec['FACTURACION ESTADO SOLUCION']||'')); tr.appendChild(tdText((rec['FACTURACION TIPO COMPROBANTE']||'').toString().toUpperCase())); tr.appendChild(tdText(rec['FACTURACION NUMERO']||'')); tr.appendChild(culminadoCell(rec)); tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['FECHA CONCLUYENTE']||'')))); tbody.appendChild(tr); }); adjustAdminTableHeightTo7(); };

    // Altura: 7 filas visibles
    const adjustAdminTableHeightTo7=()=>{ try{ const table=document.getElementById('tablaAdmin'); if(!table) return; const cont=document.getElementById('tableViewport'); const thead=table.tHead; const tbody=table.tBodies[0]; if(!thead||!tbody) return; const rows=tbody.rows; if(!rows||!rows.length){ cont.style.maxHeight=''; cont.style.overflowY=''; return; } const headerH=thead.getBoundingClientRect().height||40; const rowH=rows[0].getBoundingClientRect().height||40; const visible=Math.min(7, rows.length); const maxH=Math.ceil(headerH + rowH*visible + 2); cont.style.maxHeight=maxH+'px'; cont.style.overflow='auto'; }catch(_){ } };

    // Detalles y modales de lectura
    const showDetailById=(id)=>{ const rec=findById(id); if(!rec){ alert('No se encontró el registro.'); return; } const c=document.getElementById('detailContent'); c.innerHTML=''; const fields=[ ['ID',rec['ID']], ['Mes',rec['MES']], ['Encargado comprobante', rec['ENCARGADO DE LA VENTA']||rec['ENCARGADO DE COMPROBANTE']], ['Fecha de emisión', fmtDateDisplay(rec['FECHA DE EMISION'])], ['N° proforma/acta', rec['N° DE PROFORMA']||rec['N° PROFORMA O ACTA']], ['N° de comprobante', rec['N° DE COMPROBANTE']], ['Responsable', rec['RESPONSABLE']], ['Área', rec['AREA']||''], ['Tipo de incidencia', rec['OBSERVACIONES']||''], ['Fecha de notificación', fmtDateOnly(rec['FECHA NOTIFICACION']||'')], ['Solución', rec['SOLUCION']||''], ['Obs. adicionales', rec['OBSERVACIONES_ADMIN']||''], ['Revisado por', rec['REVISADO POR']||''], ['Estado de verificación', rec['ESTADO VERIFICACION']||''], ['Fecha envío de archivo', fmtDateDisplay(rec['FECHA ENVIO ARCHIVO']||'')], ['Culminado', rec['CULMINADO']||'NO'] ]; fields.forEach(([l,v])=>{ const p=document.createElement('p'); const strong=document.createElement('strong'); strong.textContent=l+': '; p.appendChild(strong); p.appendChild(document.createTextNode(v||'')); c.appendChild(p); }); if(rec['ITEMS']&&rec['ITEMS'].length){ const ul=document.createElement('ul'); rec['ITEMS'].forEach((it,i)=>{ const li=document.createElement('li'); li.appendChild(document.createTextNode(`Detalle ${i+1}: ${it['DETALLE DE ERROR']||''}`)); li.appendChild(document.createElement('br')); li.appendChild(document.createTextNode(`Debe ser ${i+1}: ${it['DEBE SER']||''}`)); ul.appendChild(li); }); c.appendChild(ul);} document.getElementById('detailModal').style.display='flex'; };

    const isUrl=(s)=>{ try{ const u=new URL(s); return u.protocol==='http:'||u.protocol==='https:'; }catch{ return false; } };
    const openViewTextModalById=(id)=>{ const rec=findById(id); if(!rec){ alert('No se encontró el registro.'); return; } const cont=document.getElementById('viewArchivoContent'); cont.innerHTML=''; const txt=(rec['ARCHIVO SOLUCION TEXTO']||'').trim(); if(!txt){ cont.textContent='(Sin texto/enlace)'; } else if(isUrl(txt)){ const a=document.createElement('a'); a.href=txt; a.target='_blank'; a.textContent=txt; cont.appendChild(a);} else { const pre=document.createElement('div'); pre.className='prelike'; pre.textContent=txt; cont.appendChild(pre);} document.getElementById('viewTextModal').style.display='flex'; };

    const openObsModalById=(id)=>{ const rec=findById(id); if(!rec){ alert('No se encontró el registro.'); return; } const txt=(rec['OBSERVACIONES_ADMIN']||'').trim(); document.getElementById('obsContent').textContent=txt||'(Sin observaciones)'; document.getElementById('obsModal').style.display='flex'; };

    // Guardados (Admin)
    const performVerificationSave=(id,{solucion,obs,revisado,estado})=>{ const rec=findById(id); if(!rec) return false; rec['FECHA NOTIFICACION']=nowLocalISO(); rec['SOLUCION']=solucion||''; rec['OBSERVACIONES_ADMIN']=obs||''; rec['REVISADO POR']=revisado||''; rec['ESTADO VERIFICACION']=(estado||'').toUpperCase(); rec['ENVIAR_A_FACTURACION']=(solucion||'').toLowerCase()!=='sin incidencia'; upsertStoredById(rec); return true; };
    const performCulminadoSave=(id,estado)=>{ const rec=findById(id); if(!rec) return false; rec['CULMINADO']=estado==='SI'?'SI':'NO'; rec['FECHA CULMINADO']=nowLocalISO(); if(estado==='SI') rec['FECHA CONCLUYENTE']=nowLocalISO(); else rec['FECHA CONCLUYENTE']=''; upsertStoredById(rec); return true; };

    // Apertura de modales
    let currentEditId=null;
    const openVerifModal=(id)=>{ currentEditId=id; const rec=findById(id); if(!rec){ alert('No se encontró el registro.'); return; } document.getElementById('vSolucion').value=rec['SOLUCION']||''; document.getElementById('vObs').value=rec['OBSERVACIONES_ADMIN']||''; document.getElementById('vRevisado').value=(rec['REVISADO POR']||'').toUpperCase(); const estado=(rec['ESTADO VERIFICACION']||''); const options=['PENDIENTE','EN REVISIÓN','NOTIFICADO','COMPLETADO','OBSERVADO']; const match=options.find(x=>x===(estado||'').toUpperCase()); document.getElementById('vEstado').value=match||'PENDIENTE'; document.getElementById('verifModal').style.display='flex'; };
    const openCulmModal=(id)=>{ currentEditId=id; const rec=findById(id); if(!rec){ alert('No se encontró el registro.'); return; } const val=(rec['CULMINADO']||'NO').toUpperCase()==='SI'; document.querySelectorAll('input[name="culmState"]').forEach(r=>{ r.checked=(r.value==='SI')?val:!val; }); document.getElementById('culmModal').style.display='flex'; };

    // Clicks globales (una sola vez)
    window.addEventListener('load', ()=>{
      renderList(); adjustAdminTableHeightTo7();

      // Acciones tabla (delegación)
      document.getElementById('tablaAdmin').addEventListener('click', (e)=>{
        const t=e.target.closest('a,button'); if(!t) return; const id=t.dataset.id; const action=t.dataset.action; if(action==='view'){ e.preventDefault(); showDetailById(id);} if(action==='pdf'){ e.preventDefault(); generatePDFById(id);} if(action==='view-text'){ e.preventDefault(); openViewTextModalById(id);} if(action==='view-obs'){ e.preventDefault(); openObsModalById(id);} if(action==='edit-verif'){ e.preventDefault(); openVerifModal(id);} if(action==='edit-culm'){ e.preventDefault(); openCulmModal(id);} });

      // Filtros & reportes
      document.getElementById('applyFilter').onclick=()=>renderList();
      document.getElementById('clearFilters').onclick=()=>{ document.getElementById('filterEstado').value='TODOS'; document.getElementById('filterStart').value=''; document.getElementById('filterEnd').value=''; renderList(); };
      document.getElementById('exportCSV').onclick=()=>{ const table=document.getElementById('tablaAdmin'); const header=[...table.tHead.rows[0].cells].map(th=>`"${th.innerText.replace(/"/g,'""')}"`).join(','); const body=[...table.tBodies[0].rows].map(tr=>[...tr.cells].map(td=>`"${td.innerText.replace(/"/g,'""')}"`).join(',')).join('\n'); const csv=header+'\n'+body; const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='incidencias_administracion.csv'; a.click(); URL.revokeObjectURL(url); };
      document.getElementById('generateReport').onclick=async()=>{ const table=document.getElementById('tablaAdmin'); const canvas=await html2canvas(table); const img=canvas.toDataURL('image/png'); const { jsPDF }=window.jspdf; const pdf=new jsPDF({orientation:'landscape'}); const props=pdf.getImageProperties(img); const pdfW=pdf.internal.pageSize.getWidth(); const pdfH=(props.height*pdfW)/props.width; pdf.addImage(img,'PNG',0,10,pdfW,pdfH); pdf.save('reporte_incidencias_admin.pdf'); };

      // Procedimiento modal
      document.getElementById('btnProcedimiento').onclick=()=>{ document.getElementById('procedimientoModal').style.display='flex'; };
      document.getElementById('closeProcedimiento').onclick=()=>{ document.getElementById('procedimientoModal').style.display='none'; };

      // Cerrar modales de lectura
      document.getElementById('closeDetail').onclick=()=>{ document.getElementById('detailModal').style.display='none'; };
      document.getElementById('closeViewText').onclick=()=>{ document.getElementById('viewTextModal').style.display='none'; };
      document.getElementById('closeObs').onclick=()=>{ document.getElementById('obsModal').style.display='none'; };

      // Guardar modales de edición
      document.getElementById('vSave').onclick=()=>{ if(!currentEditId) return; const solucion=document.getElementById('vSolucion').value; const obs=document.getElementById('vObs').value; const revisado=document.getElementById('vRevisado').value; const estado=document.getElementById('vEstado').value; if(!estado){ alert('Seleccione un estado de verificación.'); return; } performVerificationSave(currentEditId,{solucion,obs,revisado,estado}); document.getElementById('verifModal').style.display='none'; renderList(); };
      document.getElementById('vCancel').onclick=()=>{ document.getElementById('verifModal').style.display='none'; };
      document.getElementById('closeVerif').onclick=()=>{ document.getElementById('verifModal').style.display='none'; };

      document.getElementById('culmSave').onclick=()=>{ if(!currentEditId) return; const estado=document.querySelector('input[name="culmState"]:checked').value; performCulminadoSave(currentEditId, estado); document.getElementById('culmModal').style.display='none'; renderList(); };
      document.getElementById('culmCancel').onclick=()=>{ document.getElementById('culmModal').style.display='none'; };
      document.getElementById('closeCulm').onclick=()=>{ document.getElementById('culmModal').style.display='none'; };

      // Autoajuste al mutar filas
      try{ const tbody=document.querySelector('#tablaAdmin tbody'); const mo=new MutationObserver(()=>adjustAdminTableHeightTo7()); mo.observe(tbody,{childList:true}); window.__adminRowsObserver=mo; }catch{}
    });

    window.addEventListener('resize', adjustAdminTableHeightTo7);
    window.addEventListener('storage', ()=>{ renderList(); adjustAdminTableHeightTo7(); });

    // ====== Pruebas rápidas ======
    const removeStoredById=(id)=>{ const s=loadStored(); const i=s.findIndex(r=>r&&r.ID===id); if(i>-1){ s.splice(i,1); saveStored(s);} };
    const runSelfTests=()=>{ console.group('Admin Tests'); const tid='INC_TEST_ADMIN'; removeStoredById(tid); upsertStoredById({ ID:tid, MES:'AGOSTO', 'ENCARGADO DE LA VENTA':'KIMBERLY', 'FECHA DE EMISION':'2025-08-11T23:32:55', 'FECHA REGISTRO':'2025-08-11T23:30:00', 'REGISTRADO POR':'JOSEPH', 'N° DE PROFORMA':'P-1', 'N° DE COMPROBANTE':'F-1', RESPONSABLE:'HERVIN', AREA:'LOGISTICA', OBSERVACIONES:'ERROR DE COLOR', ITEMS:[{ 'DETALLE DE ERROR':'X', 'DEBE SER':'Y' }], 'ESTADO VERIFICACION':'PENDIENTE', 'CULMINADO':'NO' }); const ok1=performVerificationSave(tid,{solucion:'SIN INCIDENCIA',obs:'nota',revisado:'KIMBERLY',estado:'NOTIFICADO'}); const r1=findById(tid); console.assert(ok1 && r1['FECHA NOTIFICACION'], 'FECHA NOTIFICACION automática'); console.assert(r1['ESTADO VERIFICACION']==='NOTIFICADO', 'Estado en MAYÚSCULAS'); console.assert(r1['ENVIAR_A_FACTURACION']===false, 'SIN INCIDENCIA => no facturación'); const ok2=performCulminadoSave(tid,'SI'); const r2=findById(tid); console.assert(ok2 && r2['FECHA CONCLUYENTE'], 'FECHA CONCLUYENTE al culminar SI'); const sCell=archivoCellReadOnly({ ID:'X', 'ARCHIVO SOLUCION DATAURL':'data:application/pdf;base64,AA', 'ARCHIVO SOLUCION NOMBRE':'a.pdf' }); console.assert(sCell.querySelector('a[download]'), 'PDF con atributo download'); removeStoredById(tid); console.groupEnd(); };
    runSelfTests();

    // ====== PDF por fila ======
    const generatePDFById=(id)=>{ const rec=findById(id); if(!rec){ alert('No se encontró el registro.'); return; } const { jsPDF }=window.jspdf; const doc=new jsPDF(); let y=10; doc.setFontSize(12); const lines=[`ID: ${rec['ID']}`,`Mes: ${rec['MES']}`,`Encargado: ${rec['ENCARGADO DE LA VENTA']||rec['ENCARGADO DE COMPROBANTE']}`,`Fecha emisión: ${fmtDateDisplay(rec['FECHA DE EMISION'])}`,`N° proforma/acta: ${rec['N° DE PROFORMA']||rec['N° PROFORMA O ACTA']}`,`N° comprobante: ${rec['N° DE COMPROBANTE']}`,`Responsable: ${rec['RESPONSABLE']}`,`Área: ${rec['AREA']}`,`Tipo: ${rec['OBSERVACIONES']||rec['TIPO DE INCIDENCIA']||''}`,`Fecha notificación: ${fmtDateDisplay(rec['FECHA NOTIFICACION'])}`,`Solución: ${(rec['SOLUCION']||'')}`,`Obs. adicionales: ${(rec['OBSERVACIONES_ADMIN']||'').toString().replace(/\n/g,' ')}`,`Revisado por: ${rec['REVISADO POR']||''}`,`Estado verificación: ${rec['ESTADO VERIFICACION']||''}`,`Fecha envío archivo: ${fmtDateDisplay(rec['FECHA ENVIO ARCHIVO']||'')}`,`Fecha concluyente: ${fmtDateDisplay(rec['FECHA CONCLUYENTE']||'')}`]; lines.forEach(line=>{ doc.text(line,10,y); y+=7; if(y>280){ doc.addPage(); y=10; } }); doc.save(`${rec['ID']||'incidencia'}.pdf`); };
  </script>
<script>
/* ===== ADMIN (aditivo): Si SOLUCIÓN = "SIN INCIDENCIA" → autocompletar campos de Facturación.
   Si cambia a otra solución, limpiar esos campos. Intercepta localStorage.setItem y normaliza al cargar.
   Idempotente: si ya existe __admin_applySinIncidenciaRule, no vuelve a parchear. */
(function(){
  'use strict';
  if (window.__admin_applySinIncidenciaRule) { return; }

  function normalizeUpper(s){
    return String(s||'')
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .toUpperCase().trim();
  }

  const F_KEYS = {
    FECHA:  'FACTURACION FECHA CORRECCION',
    ESTADO: 'FACTURACION ESTADO SOLUCION',
    TIPO:   'FACTURACION TIPO COMPROBANTE',
    NUM:    'FACTURACION NUMERO'
  };

  function applyRuleInPlace(rec){
    if(!rec || typeof rec!=='object') return false;
    const sol = normalizeUpper(rec['SOLUCION DE COMPROBANTE'] ?? rec['SOLUCION'] ?? rec['SOLUCIÓN'] ?? '');
    let changed=false;
    if(sol === 'SIN INCIDENCIA'){
      if(rec[F_KEYS.FECHA]  !== 'SIN INCIDENCIA'){ rec[F_KEYS.FECHA]  = 'SIN INCIDENCIA'; changed=true; }
      if(rec[F_KEYS.ESTADO] !== 'SIN INCIDENCIA'){ rec[F_KEYS.ESTADO] = 'SIN INCIDENCIA'; changed=true; }
      if(rec[F_KEYS.TIPO]   !== 'SIN INCIDENCIA'){ rec[F_KEYS.TIPO]   = 'SIN INCIDENCIA'; changed=true; }
      if(rec[F_KEYS.NUM]    !== 'SIN INCIDENCIA'){ rec[F_KEYS.NUM]    = 'SIN INCIDENCIA'; changed=true; }
    } else if (sol) {
      if(rec[F_KEYS.FECHA])  { rec[F_KEYS.FECHA]  = ''; changed=true; }
      if(rec[F_KEYS.ESTADO]) { rec[F_KEYS.ESTADO] = ''; changed=true; }
      if(rec[F_KEYS.TIPO])   { rec[F_KEYS.TIPO]   = ''; changed=true; }
      if(rec[F_KEYS.NUM])    { rec[F_KEYS.NUM]    = ''; changed=true; }
    }
    return changed;
  }

  try{
    const _setItem = localStorage.setItem.bind(localStorage);
    localStorage.setItem = function(key, value){
      try{
        if(key === (window.STORAGE_KEY || 'incidencias_v12') && typeof value === 'string'){
          const parsed = JSON.parse(value);
          if(Array.isArray(parsed)){
            let changed=false;
            parsed.forEach(rec=>{ if(applyRuleInPlace(rec)) changed=true; });
            if(changed) value = JSON.stringify(parsed);
          }
        }
      }catch(err){ /* no-op */ }
      return _setItem(key, value);
    };
  }catch(err){ /* no-op */ }

  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      const key = window.STORAGE_KEY || 'incidencias_v12';
      const raw = localStorage.getItem(key); if(!raw) return;
      const arr = JSON.parse(raw); if(!Array.isArray(arr)) return;
      let changed=false; arr.forEach(rec=>{ if(applyRuleInPlace(rec)) changed=true; });
      if(changed){ localStorage.setItem(key, JSON.stringify(arr)); }
    }catch(err){ /* no-op */ }
  });

  window.__admin_applySinIncidenciaRule = applyRuleInPlace;
})();
</script>
</body>
</html>