<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Área de Logística: Registro y seguimiento de incidencias (v12)</title>
  <style>
    /* Importar Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #1e293b;
      line-height: 1.6;
    }
    
    /* Header mejorado */
    header {
      display: flex;
      align-items: center;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #17375d 0%, #1e4d7a 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(23, 55, 93, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      opacity: 0.3;
    }
    
    header img {
      height: 45px;
      margin-right: 1.5rem;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
      position: relative;
      z-index: 1;
    }
    
    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
      position: relative;
      z-index: 1;
      letter-spacing: -0.025em;
    }
    
    /* Botón volver mejorado */
    .btn-back {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(100, 116, 139, 0.3);
      margin: 1rem 0 0 1rem;
    }
    
    .btn-back:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(100, 116, 139, 0.4);
    }
    
    /* Container principal */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    /* Cards mejoradas */
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
      overflow: hidden;
      border: 1px solid rgba(226, 232, 240, 0.8);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
    }
    
    .card-header {
      background: linear-gradient(135deg, #2f75b5 0%, #1e4d7a 100%);
      color: white;
      padding: 1.5rem 2rem;
      position: relative;
      overflow: hidden;
    }
    
    .card-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
      animation: shimmer 3s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .card-header h2 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      position: relative;
      z-index: 1;
    }
    
    .card-body {
      padding: 2rem;
    }
    
    /* Formulario mejorado */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .form-group {
      flex: 1 1 300px;
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #374151;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.875rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: all 0.3s ease;
      background: #fafafa;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #2f75b5;
      background: white;
      box-shadow: 0 0 0 3px rgba(47, 117, 181, 0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    /* Botones mejorados */
    .btn {
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      font-family: inherit;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #17375d 0%, #1e4d7a 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(23, 55, 93, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(23, 55, 93, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #4f81bd 0%, #3b6aa0 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(79, 129, 189, 0.3);
    }
    
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 129, 189, 0.4);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }
    
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
    }
    
    /* Tabla mejorada */
    .table-responsive {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }
    
    th {
      background: linear-gradient(135deg, #17375d 0%, #1e4d7a 100%);
      color: white;
      padding: 1rem;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border: none;
    }
    
    td {
      padding: 1rem;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }
    
    tr:hover td {
      background-color: #f8fafc;
    }
    
    td:nth-child(3),
    td:nth-child(10) {
      white-space: nowrap;
    }
    
    /* Enlaces mejorados */
    .view-link {
      color: #2f75b5;
      text-decoration: none;
      cursor: pointer;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      background: rgba(47, 117, 181, 0.1);
      transition: all 0.3s ease;
      display: inline-block;
    }
    
    .view-link:hover {
      background: rgba(47, 117, 181, 0.2);
      transform: translateY(-1px);
    }
    
    /* Badges mejorados */
    .badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: inline-block;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .badge-pendiente {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .badge-enproceso {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    }
    
    .badge-completado {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    /* Filtros mejorados */
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: end;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }
    
    .filter-group label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #374151;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .filter-group input,
    .filter-group select {
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: white;
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #2f75b5;
      box-shadow: 0 0 0 3px rgba(47, 117, 181, 0.1);
    }
    
    /* Items row mejorado */
    .item-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: flex-start;
    }
    
    .item-row textarea {
      flex: 1 1 48%;
      min-height: 80px;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 0.9rem;
      font-family: inherit;
      transition: all 0.3s ease;
      background: #fafafa;
    }
    
    .item-row textarea:focus {
      outline: none;
      border-color: #2f75b5;
      background: white;
      box-shadow: 0 0 0 3px rgba(47, 117, 181, 0.1);
    }
    
    /* Modal mejorado */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 2rem;
    }
    
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 100px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(226, 232, 240, 0.8);
    }
    
    .modal-close {
      background: transparent;
      border: none;
      font-size: 2rem;
      float: right;
      cursor: pointer;
      color: #64748b;
      transition: color 0.3s ease;
      margin-bottom: 1rem;
    }
    
    .modal-close:hover {
      color: #1e293b;
    }
    
    /* Modal sections mejoradas */
    .modal-section {
      margin-bottom: 2.5rem;
      padding: 2rem;
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .modal-section h3 {
      margin-top: 0;
      color: #17375d;
      border-bottom: 3px solid #17375d;
      padding-bottom: 1rem;
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }
    
    .modal-form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .modal-form-group {
      flex: 1 1 300px;
    }
    
    .modal-form-group label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.75rem;
      color: #374151;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .modal-form-group input,
    .modal-form-group select,
    .modal-form-group textarea {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: all 0.3s ease;
      background: white;
    }
    
    .modal-form-group input:focus,
    .modal-form-group select:focus,
    .modal-form-group textarea:focus {
      outline: none;
      border-color: #2f75b5;
      box-shadow: 0 0 0 3px rgba(47, 117, 181, 0.1);
    }
    
    .modal-form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .modal-buttons {
      text-align: right;
      margin-top: 2rem;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .card-body {
        padding: 1.5rem;
      }
      
      .form-row {
        gap: 1rem;
      }
      
      .form-group {
        flex: 1 1 100%;
      }
      
      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .modal-content {
        padding: 1.5rem;
        margin: 1rem;
      }
    }
    
    /* Animaciones suaves */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
      animation: fadeIn 0.6s ease-out;
    }
    
    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #17375d 0%, #2f75b5 100%);
      border-radius: 4px;
    }
    
         ::-webkit-scrollbar-thumb:hover {
       background: linear-gradient(135deg, #1e4d7a 0%, #1e4d7a 100%);
     }
     
     /* Notificaciones */
     .notification {
       position: fixed;
       top: 20px;
       right: 20px;
       padding: 1rem 1.5rem;
       border-radius: 12px;
       color: white;
       font-weight: 600;
       z-index: 10000;
       transform: translateX(400px);
       transition: transform 0.3s ease;
       box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
     }
     
     .notification.show {
       transform: translateX(0);
     }
     
     .notification.success {
       background: linear-gradient(135deg, #10b981 0%, #059669 100%);
     }
     
     .notification.error {
       background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
     }
   </style>
</head>
<body>
  <header>
    <img src="logo_empresa.png" alt="Logo" onerror="this.style.display='none'" />
    <h1>Área de Logística: Registro y seguimiento de incidencias</h1>
  </header>

  <button href="../../logistica.html" class="btn-back">
              <i class="bi bi-arrow-left"></i> Volver
            </button>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h2>Registrar nueva incidencia</h2>
      </div>
      <div class="card-body">
        <form id="formLogistica">
          <div class="form-row">
            <div class="form-group">
              <label for="encargado">Encargado del Comprobante *</label>
              <!-- Lista desplegable con nombres de los asesores de venta -->
              <select id="encargado" required>
                <option value="">Seleccione...</option>
                <option value="HERVIN">Hervin</option>
                <option value="KIMBERLY">Kimberly</option>
                <option value="JOSE">Jose</option>
                <option value="ALVARO">Alvaro</option>
                <option value="EVELYN">Evelyn</option>
                <option value="LIZETH">Lizeth</option>
                <option value="JOSEPH">Joseph</option>
                <option value="MANUEL">Manuel</option>
                <option value="JOSSELYN">Joselyn</option>
              </select>
            </div>
            <div class="form-group">
              <label for="fechaEmision">Fecha de emisión *</label>
              <input type="date" id="fechaEmision" required />
            </div>
            <div class="form-group">
              <label for="responsable">Responsable incidencia *</label>
              <!-- Lista desplegable de responsables -->
              <select id="responsable" required>
                <option value="">Seleccione...</option>
                <option value="SANDRA">Sandra</option>
                <option value="JOSE">Jose</option>
                <option value="KIMBERLY">Kimberly</option>
                <option value="JOSEPH">Joseph</option>
                <option value="MANUEL">Manuel</option>
                <option value="JOSELYN">Joselyn</option>
                <option value="VICTOR">Victor</option>
                <option value="HERVIN">Hervin</option>
                <option value="ALVARO">Alvaro</option>
                <option value="EVELYN">Evelyn</option>
                <option value="LIZETH">Lizeth</option>
              </select>
            </div>
            <div class="form-group">
              <label for="area">Área *</label>
              <select id="area" required>
                <option value="">Seleccione...</option>
                <option value="VENTAS">Ventas</option>
                <option value="FACTURACION">Facturación</option>
                <option value="LOGISTICA">Logística</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="proforma">N° de proforma *</label>
              <input type="text" id="proforma" required />
            </div>
            <div class="form-group">
              <label for="comprobante">N° de comprobante *</label>
              <input type="text" id="comprobante" required />
            </div>
          </div>
          <div class="form-group">
            <label>Ítems (detalle de error y debe ser)</label>
            <div id="itemsContainer"></div>
            <button type="button" class="btn btn-secondary" id="addItem">Agregar ítem</button>
          </div>
          <!-- Tipo de incidencia y observación detallada -->
          <div class="form-row">
            <div class="form-group" style="flex:1 1 200px;">
              <label for="tipoIncidencia">Tipo de incidencia *</label>
              <select id="tipoIncidencia" required>
                <option value="">Seleccione...</option>
                <option value="ERROR DE COLOR">ERROR DE COLOR</option>
                <option value="ERROR DE TALLA">ERROR DE TALLA</option>
                <option value="ERROR DE CANTIDAD O PRECIO">ERROR DE CANTIDAD O PRECIO</option>
                <option value="OTROS">OTROS</option>
              </select>
            </div>
            <div class="form-group" style="flex:1 1 200px;">
              <label for="observacionDetalle">Observación detallada</label>
              <textarea id="observacionDetalle" placeholder="Describa la incidencia"></textarea>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Guardar incidencia</button>
        </form>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h2>Listado de incidencias</h2>
      </div>
      <div class="card-body">
        <div class="filter-row">
          <div class="filter-group">
            <label for="filterEstado">Filtrar por estado</label>
            <select id="filterEstado">
              <option value="TODOS">Todos</option>
              <option value="PENDIENTE">Pendiente</option>
              <option value="EN PROCESO">En proceso</option>
              <option value="COMPLETADO">Completado</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Estadísticas</label>
            <div id="statsInfo" style="padding: 0.5rem; background: rgba(47, 117, 181, 0.1); border-radius: 8px; font-size: 0.8rem; color: #17375d;">
              <span id="apiCount">0</span> registros de API
            </div>
          </div>
          <div class="filter-group">
            <label for="filterStart">Desde</label>
            <input type="date" id="filterStart" />
          </div>
          <div class="filter-group">
            <label for="filterEnd">Hasta</label>
            <input type="date" id="filterEnd" />
          </div>
          <div class="filter-group" style="margin-top:1.25rem;">
            <button id="applyFilter" class="btn btn-secondary">Aplicar filtros</button>
          </div>
                     <div style="margin-left:auto; display:flex; gap:0.5rem; align-items:center;">
             <button id="refreshAPI" class="btn btn-secondary">🔄 Refrescar Datos</button>
             <button id="exportCSV" class="btn btn-secondary">Exportar CSV</button>
             <!-- Generador de reportes (reemplaza limpiar registros) -->
             <button id="generateReport" class="btn btn-secondary">Generar reporte</button>
           </div>
        </div>
        <div class="table-responsive">
          <table id="tablaIncidencias">
            <thead>
              <tr>
                <th>N° Solicitud</th>
                <th>Encargado</th>
                <th>Fecha emisión</th>
                <th>N° proforma</th>
                <th>N° comprobante</th>
                <th>Responsable</th>
                <th>Área</th>
                <th>Tipo de incidencia</th>
                <th>Estado</th>
                <th>Ver Detalle</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal para detalles -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeDetail">&times;</button>
      <div id="detailContent"></div>
    </div>
  </div>
  <!-- Librerías para generación de reportes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Configuración de la API
    const API_URL = "https://incidenciaslogisticaproformas-2946605267.us-central1.run.app";
    const API_PARAMS = { tipo: "listado" };
    const API_HEADERS = { "Content-Type": "application/json" };
    
    // Variable para almacenar datos de la API
    let apiData = [];
    
    // Función para consumir la API
    async function fetchAPIData() {
      console.log("=== INICIO fetchAPIData ===");
      console.log("API_URL:", API_URL);
      console.log("API_PARAMS:", API_PARAMS);
      console.log("API_HEADERS:", API_HEADERS);
      
      try {
        const url = new URL(API_URL);
        Object.keys(API_PARAMS).forEach(key => url.searchParams.append(key, API_PARAMS[key]));
        console.log("URL final construida:", url.toString());
        
        console.log("Realizando fetch GET a la API...");
        const response = await fetch(url, {
          method: 'GET',
          headers: API_HEADERS
        });
        
        console.log("Respuesta recibida de la API:");
        console.log("- Status:", response.status);
        console.log("- Status Text:", response.statusText);
        console.log("- Headers:", Object.fromEntries(response.headers.entries()));
        
        if (response.status === 200) {
          console.log("✅ Datos extraídos correctamente de la API");
          const data = await response.json();
          console.log("Datos JSON obtenidos:", data);
          return data;
        } else {
          console.error("❌ Error al extraer los datos de la API:");
          console.error("- Status Code:", response.status);
          console.error("- Status Text:", response.statusText);
          
          // Intentar obtener el texto de la respuesta
          try {
            const errorText = await response.text();
            console.error("- Response Text:", errorText);
          } catch (textError) {
            console.error("- No se pudo leer el texto de la respuesta:", textError);
          }
          
          return [];
        }
      } catch (error) {
        console.error("❌ Error al consumir la API:");
        console.error("- Error Type:", error.constructor.name);
        console.error("- Error Message:", error.message);
        console.error("- Error Stack:", error.stack);
        console.error("- Error Details:", error);
        return [];
      } finally {
        console.log("=== FIN fetchAPIData ===");
      }
    }
    
    // Función para mapear datos de la API al formato de la tabla
    function mapAPIDataToTableFormat(apiData) {
      console.log("=== MAPAPIDATATOTABLEFORMAT DEBUG ===");
      console.log("Datos originales de la API:", apiData);
      
      return apiData.map(item => {
        console.log("Procesando item:", item);
        console.log("TIPO_INDICENCIA value:", item.TIPO_INDICENCIA);
        
        return {
          'N° SOLICITUD': item.ID || '',
          'ENCARGADO DE LA VENTA': item.ENCARGADO_COMPROBANTE || '',
          'FECHA DE EMISION': item.FECHA_EMISION || '',
          'N° DE PROFORMA': item.NUMERO_PROFORMA || '',
          'N° DE COMPROBANTE': item.NUMERO_COMPROBANTE || '',
          'RESPONSABLE': item.RESPONSABLE_INCIDENCIA || '',
          'AREA': item.AREA || '',
          'OBSERVACIONES': item.TIPO_INDICENCIA || '',
          'ESTADO': item.ESTADO_INCIDENCIA || '',
          'OBSERVACION_DETALLE': '',
          'FECHA DE CORRECCION ': '',
          'SOLUCION DE COMPROBANTE': '',
          'OBSERVACIONES_ADMIN': '',
          'MODIFICADO POR': '',
          'ITEMS': []
        };
      });
    }
    // Añadir fila de ítem
    function addItemRow(det = '', debe = '') {
      const container = document.getElementById('itemsContainer');
      const row = document.createElement('div');
      row.className = 'item-row';
      const detArea = document.createElement('textarea');
      detArea.placeholder = 'Detalle de error';
      detArea.required = true;
      detArea.value = det;
      const debeArea = document.createElement('textarea');
      debeArea.placeholder = 'Debe ser';
      debeArea.required = true;
      debeArea.value = debe;
      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.className = 'btn btn-danger';
      delBtn.textContent = 'Eliminar';
      delBtn.onclick = () => row.remove();
      row.style.display = 'flex';
      row.style.gap = '0.5rem';
      row.style.marginBottom = '0.5rem';
      row.appendChild(detArea);
      row.appendChild(debeArea);
      row.appendChild(delBtn);
      container.appendChild(row);
    }
    // Obtener clase de badge según estado
  function badgeClass(val) {
      const v = (val || '').toUpperCase();
      if (v === 'PENDIENTE') return 'badge-pendiente';
      if (v === 'EN PROCESO') return 'badge-enproceso';
      if (v === 'COMPLETADO') return 'badge-completado';
      return '';
    }  


    // Renderizar listado de incidencias
    function renderList() {
      const tbody = document.querySelector('#tablaIncidencias tbody');
      tbody.innerHTML = '';
      const estadoFiltro = document.getElementById('filterEstado').value;
      const start = document.getElementById('filterStart').value;
      const end = document.getElementById('filterEnd').value;
      
      console.log("=== RENDERLIST DEBUG ===");
      console.log("Datos API:", apiData.length, "registros");
      
      apiData.forEach((rec, idx) => {
        const estado = rec['ESTADO'] || '';
        console.log("=== RENDERLIST ITEM DEBUG ===");
        console.log("Índice:", idx);
        console.log("OBSERVACIONES (TIPO_INDICENCIA):", rec['OBSERVACIONES']);
        
        // Filtrar por estado
        if (estadoFiltro !== 'TODOS' && estado.toUpperCase() !== estadoFiltro) return;
        // Filtrar por fecha
        if (start) {
          if (!rec['FECHA DE EMISION'] || rec['FECHA DE EMISION'] < start) return;
        }
        if (end) {
          if (!rec['FECHA DE EMISION'] || rec['FECHA DE EMISION'] > end) return;
        }
        const tr = document.createElement('tr');
        const cells = [
          rec['N° SOLICITUD'] || idx + 1,
          rec['ENCARGADO DE LA VENTA'] || '',
          rec['FECHA DE EMISION'] || '',
          rec['N° DE PROFORMA'] || '',
          rec['N° DE COMPROBANTE'] || '',
          rec['RESPONSABLE'] || '',
          rec['AREA'] || '',
          rec['OBSERVACIONES'] || '',
          '<span class="badge ' + badgeClass(estado) + '">' + (estado || '') + '</span>',
          '<span class="view-link" data-index="' + idx + '">Ver Detalle</span>'
        ];
        cells.forEach((html) => {
          const td = document.createElement('td');
          td.innerHTML = html;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      // Asignar eventos a enlaces Ver Detalle
      document.querySelectorAll('.view-link').forEach((el) => {
        el.addEventListener('click', function (e) {
          e.preventDefault();
          const i = parseInt(this.dataset.index);
          showDetail(i);
        });
      });
      
      // Actualizar estadísticas
      updateStats();
    }
    // Mostrar detalles de una incidencia en modal
    function showDetail(index) {
      const rec = apiData[index];
      console.log("=== SHOWDETAIL DEBUG ===");
      console.log("Índice:", index);
      console.log("Datos del registro:", rec);
      console.log("OBSERVACIONES (TIPO_INDICENCIA):", rec['OBSERVACIONES']);
      console.log("OBSERVACION_DETALLE:", rec['OBSERVACION_DETALLE']);
      
      const container = document.getElementById('detailContent');
      container.innerHTML = '';
      
      // Sección 1: Incidencia Descripción
      const section1 = document.createElement('div');
      section1.className = 'modal-section';
      section1.innerHTML = `
        <h3>Incidencia Descripción</h3>
        <div class="modal-form-row">
          <div class="modal-form-group">
            <label>Encargado del Comprobante</label>
            <input type="text" value="${rec['ENCARGADO DE LA VENTA'] || ''}" readonly>
          </div>
          <div class="modal-form-group">
            <label>Fecha de emisión</label>
            <input type="text" value="${rec['FECHA DE EMISION'] || ''}" readonly>
          </div>
        </div>
        <div class="modal-form-row">
          <div class="modal-form-group">
            <label>N° de proforma</label>
            <input type="text" value="${rec['N° DE PROFORMA'] || ''}" readonly>
          </div>
          <div class="modal-form-group">
            <label>N° de comprobante</label>
            <input type="text" value="${rec['N° DE COMPROBANTE'] || ''}" readonly>
          </div>
        </div>
        <div class="modal-form-row">
          <div class="modal-form-group">
            <label>Responsable</label>
            <input type="text" value="${rec['RESPONSABLE'] || ''}" readonly>
          </div>
          <div class="modal-form-group">
            <label>Área</label>
            <input type="text" value="${rec['AREA'] || ''}" readonly>
          </div>
        </div>
        <div class="modal-form-row">
          <div class="modal-form-group">
            <label>Tipo de incidencia</label>
            <input type="text" value="${rec['OBSERVACIONES'] || ''}" readonly>
          </div>
        </div>
        <div class="modal-form-row">
          <div class="modal-form-group">
            <label>Observación detallada</label>
            <textarea readonly>${rec['OBSERVACION_DETALLE'] || ''}</textarea>
          </div>
        </div>
      `;
      
      // Agregar ítems si existen
      if (rec['ITEMS'] && rec['ITEMS'].length) {
        const itemsSection = document.createElement('div');
        itemsSection.innerHTML = '<h4>Detalle de error y Debe ser:</h4>';
        const itemsList = document.createElement('ul');
        rec['ITEMS'].forEach((item, idx) => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>Item ${idx + 1}:</strong><br>
            <strong>Detalle de error:</strong> ${item['DETALLE DE ERROR'] || ''}<br>
            <strong>Debe ser:</strong> ${item['DEBE SER'] || ''}`;
          itemsList.appendChild(li);
        });
        itemsSection.appendChild(itemsList);
        section1.appendChild(itemsSection);
      }
      
      // Sección 2: Incidencia Resuelta
      const section2 = document.createElement('div');
      section2.className = 'modal-section';
      section2.innerHTML = `
        <h3>Incidencia Resuelta</h3>
        <div class="modal-form-row">
          <div class="modal-form-group">
            <label>Solución</label>
            <textarea id="solucion" placeholder="Describa la solución">${rec['SOLUCION DE COMPROBANTE'] || ''}</textarea>
          </div>
        </div>
        <div class="modal-form-row">
          <div class="modal-form-group">
            <label>Obs. Adicionales</label>
            <textarea id="obsAdicionales" placeholder="Observaciones adicionales">${rec['OBSERVACIONES_ADMIN'] || ''}</textarea>
          </div>
        </div>
        <div class="modal-form-row">
          <div class="modal-form-group">
            <label>Modificado por</label>
            <input type="text" id="modificadoPor" placeholder="Nombre de quien modifica" value="${rec['MODIFICADO POR'] || ''}">
          </div>
          <div class="modal-form-group">
            <label>Fecha Corrección</label>
            <input type="date" id="fechaCorreccion" value="${rec['FECHA DE CORRECCION '] || ''}">
          </div>
      `;
      
      container.appendChild(section1);
      container.appendChild(section2);
      document.getElementById('detailModal').style.display = 'flex';
    }
    
    // Función para guardar cambios en el modal
    function saveChanges(index) {
      const rec = apiData[index];
      
      // Obtener valores del modal
      const solucion = document.getElementById('solucion').value;
      const obsAdicionales = document.getElementById('obsAdicionales').value;
      const modificadoPor = document.getElementById('modificadoPor').value;
      const fechaCorreccion = document.getElementById('fechaCorreccion').value;
      
      // Actualizar el registro
      rec['SOLUCION DE COMPROBANTE'] = solucion;
      rec['OBSERVACIONES_ADMIN'] = obsAdicionales;
      rec['MODIFICADO POR'] = modificadoPor;
      rec['FECHA DE CORRECCION '] = fechaCorreccion;
      
      // Si se completó la solución, cambiar estado a COMPLETADO
      if (solucion.trim() && fechaCorreccion) {
        rec['ESTADO'] = 'COMPLETADO';
      } else if (solucion.trim()) {
        rec['ESTADO'] = 'EN PROCESO';
      }
      
      // Cerrar modal y actualizar lista
      document.getElementById('detailModal').style.display = 'none';
      renderList();
    }
    
    // Cerrar modal
    document.getElementById('closeDetail').addEventListener('click', () => {
      document.getElementById('detailModal').style.display = 'none';
    });
         // Función para mostrar notificaciones
     function showNotification(message, type = 'success') {
       // Remover notificaciones existentes
       const existingNotifications = document.querySelectorAll('.notification');
       existingNotifications.forEach(notification => notification.remove());
       
       // Crear nueva notificación
       const notification = document.createElement('div');
       notification.className = `notification ${type}`;
       notification.textContent = message;
       
       document.body.appendChild(notification);
       
       // Mostrar notificación
       setTimeout(() => {
         notification.classList.add('show');
       }, 100);
       
       // Ocultar notificación después de 3 segundos
       setTimeout(() => {
         notification.classList.remove('show');
         setTimeout(() => {
           notification.remove();
         }, 300);
       }, 3000);
     }

     // Función para guardar incidencia en la API
     async function saveIncidenciaToAPI(formData) {
      console.log("=== INICIO saveIncidenciaToAPI ===");
      console.log("API_URL:", API_URL);
      console.log("API_HEADERS:", API_HEADERS);
      console.log("formData a enviar:", JSON.stringify(formData, null, 2));
      
      try {
        console.log("Realizando fetch POST a la API...");
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: API_HEADERS,
          body: JSON.stringify(formData)
        });
        
        console.log("Respuesta recibida de la API:");
        console.log("- Status:", response.status);
        console.log("- Status Text:", response.statusText);
        console.log("- Headers:", Object.fromEntries(response.headers.entries()));
        
        // Intentar obtener el texto de la respuesta
        let responseText = '';
        try {
          responseText = await response.text();
          console.log("- Response Text:", responseText);
        } catch (textError) {
          console.log("- No se pudo leer el texto de la respuesta:", textError);
        }
        
        if (response.status === 200) {
          console.log("✅ Incidencia guardada correctamente en la API");
          return true;
        } else {
          console.error("❌ Error al guardar la incidencia en la API:");
          console.error("- Status Code:", response.status);
          console.error("- Status Text:", response.statusText);
          console.error("- Response Text:", responseText);
          return false;
        }
      } catch (error) {
        console.error("❌ Error de red/excepción al guardar la incidencia:");
        console.error("- Error Type:", error.constructor.name);
        console.error("- Error Message:", error.message);
        console.error("- Error Stack:", error.stack);
        console.error("- Error Details:", error);
        return false;
      } finally {
        console.log("=== FIN saveIncidenciaToAPI ===");
      }
    }

    // Guardar incidencia
    document.getElementById('formLogistica').addEventListener('submit', async function (e) {
      console.log("=== INICIO SUBMIT FORMULARIO ===");
      e.preventDefault();
      
      // Obtener datos del formulario
      const encargado = document.getElementById('encargado').value;
      const fechaEmision = document.getElementById('fechaEmision').value;
      const proforma = document.getElementById('proforma').value;
      const comprobante = document.getElementById('comprobante').value;
      const responsable = document.getElementById('responsable').value;
      const area = document.getElementById('area').value;
      const tipoIncidencia = document.getElementById('tipoIncidencia').value;
      const observacionDetalle = document.getElementById('observacionDetalle').value || '';
      
      console.log("Datos del formulario obtenidos:");
      console.log("- encargado:", encargado);
      console.log("- fechaEmision:", fechaEmision);
      console.log("- proforma:", proforma);
      console.log("- comprobante:", comprobante);
      console.log("- responsable:", responsable);
      console.log("- area:", area);
      console.log("- tipoIncidencia:", tipoIncidencia);
      console.log("- observacionDetalle:", observacionDetalle);
      
      // Obtener ítems del formulario
      const itemsContainer = document.getElementById('itemsContainer');
      const rows = itemsContainer.querySelectorAll('.item-row');
      console.log("Filas de items encontradas:", rows.length);
      
      const detalle = [];
      rows.forEach((r, index) => {
        const det = r.children[0].value;
        const debe = r.children[1].value;
        console.log(`Item ${index + 1}:`, { det, debe });
        if (det && debe) {
          detalle.push({
            "error": det,
            "solucion": debe
          });
        }
      });
      
      console.log("Array detalle final:", detalle);
      
      // Preparar datos para la API
      const fechaCompleta = fechaEmision ? (fechaEmision + ' ' + new Date().toLocaleTimeString()) : '';
      console.log("Fecha completa generada:", fechaCompleta);
      
      const apiData = {
        "fecha_emision": fechaCompleta,
        "encargado_comprobante": encargado,
        "responsable_incidencia": responsable,
        "area": area,
        "numero_proforma": proforma,
        "numero_comprobante": comprobante,
        "tipo_incidencia": tipoIncidencia,
        "observacion": observacionDetalle,
        "detalle": detalle
      };
      
      console.log("Datos preparados para la API:", JSON.stringify(apiData, null, 2));
      
      // Mostrar estado de carga
      const submitButton = this.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.textContent = '🔄 Guardando...';
      submitButton.disabled = true;
      
      try {
        console.log("Iniciando guardado en la API...");
        // Guardar en la API
        const success = await saveIncidenciaToAPI(apiData);
        console.log("Resultado del guardado en API:", success);
        
        if (success) {
          console.log("✅ Guardado exitoso en la API");
          
          // Limpiar formulario
          this.reset();
          document.getElementById('itemsContainer').innerHTML = '';
          console.log("✅ Formulario limpiado");
          
          // Refrescar datos de la API y actualizar tabla
          console.log("Refrescando datos de la API...");
          await loadAPIData();
          console.log("Actualizando tabla...");
          renderList();
          
                     // Mostrar mensaje de éxito
           submitButton.textContent = '✅ Guardado';
           showNotification('✅ Incidencia guardada exitosamente en la API', 'success');
           setTimeout(() => {
             submitButton.textContent = originalText;
             submitButton.disabled = false;
           }, 2000);
           
         } else {
           console.log("❌ Guardado fallido en la API");
           // Mostrar error
           submitButton.textContent = '❌ Error';
           showNotification('❌ Error al guardar la incidencia. Por favor, intente nuevamente.', 'error');
           setTimeout(() => {
             submitButton.textContent = originalText;
             submitButton.disabled = false;
           }, 2000);
         }
         
       } catch (error) {
         console.error('❌ Error en el proceso de guardado:');
         console.error('- Error Type:', error.constructor.name);
         console.error('- Error Message:', error.message);
         console.error('- Error Stack:', error.stack);
         console.error('- Error Details:', error);
         submitButton.textContent = '❌ Error';
         showNotification('❌ Error al guardar la incidencia. Por favor, intente nuevamente.', 'error');
         setTimeout(() => {
           submitButton.textContent = originalText;
           submitButton.disabled = false;
         }, 2000);
       } finally {
         console.log("=== FIN SUBMIT FORMULARIO ===");
       }
    });
    // Agregar ítem
    document.getElementById('addItem').addEventListener('click', () => addItemRow());

    // Habilitar/deshabilitar observación detallada según el tipo de incidencia
    document.getElementById('tipoIncidencia').addEventListener('change', function() {
      const detField = document.getElementById('observacionDetalle');
      // Ahora siempre está habilitado
      detField.disabled = false;
    });
    // Exportar CSV
    document.getElementById('exportCSV').addEventListener('click', function () {
      let csv = 'N° SOLICITUD,ENCARGADO DE LA VENTA,FECHA DE EMISION,N° DE PROFORMA,N° DE COMPROBANTE,DETALLE DE ERROR,DEBE SER,RESPONSABLE,AREA,TIPO DE INCIDENCIA,OBSERVACION DETALLADA,FECHA DE CORRECCION,ESTADO,SOLUCION DE COMPROBANTE,OBSERVACIONES ADICIONALES,MODIFICADO POR\n';
      apiData.forEach((rec) => {
        const items = rec['ITEMS'] && rec['ITEMS'].length ? rec['ITEMS'] : [{ 'DETALLE DE ERROR': '', 'DEBE SER': '' }];
        items.forEach((item) => {
        const row = [
            rec['N° SOLICITUD'] || '',
            rec['ENCARGADO DE LA VENTA'] || '',
            rec['FECHA DE EMISION'] || '',
            rec['N° DE PROFORMA'] || '',
            rec['N° DE COMPROBANTE'] || '',
            item['DETALLE DE ERROR'] || '',
            item['DEBE SER'] || '',
            rec['RESPONSABLE'] || '',
            rec['AREA'] || '',
            rec['OBSERVACIONES'] || '',
            rec['OBSERVACION_DETALLE'] || '',
            rec['FECHA DE CORRECCION '] || '',
            rec['ESTADO'] || '',
            rec['SOLUCION DE COMPROBANTE'] || '',
            rec['OBSERVACIONES_ADMIN'] || '',
            rec['MODIFICADO POR'] || ''
          ];
          csv += row.map((x) => '"' + (x || '').replace(/"/g, '""') + '"').join(',') + '\n';
        });
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'incidencias_logistica.csv';
      a.click();
      URL.revokeObjectURL(url);
    });
    // Generar reporte en PDF de todas las incidencias
    document.getElementById('generateReport').addEventListener('click', async () => {
      // Captura la tabla filtrada y genera un PDF como imagen
      const table = document.querySelector('#tablaIncidencias');
      if (!table) return;
      const canvas = await html2canvas(table);
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      // Usamos orientación horizontal para ajustarse a la tabla
      const doc = new jsPDF('l', 'pt', 'a4');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const imgWidth = pageWidth - 20; // márgenes
      const imgHeight = canvas.height * imgWidth / canvas.width;
      // Si la imagen es más alta que la página, escalar a la altura máxima
      const finalHeight = imgHeight > pageHeight - 20 ? pageHeight - 20 : imgHeight;
      const finalWidth = imgHeight > pageHeight - 20 ? (canvas.width * finalHeight / canvas.height) : imgWidth;
      const x = (pageWidth - finalWidth) / 2;
      const y = 10;
      doc.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
      doc.save('reporte_incidencias_logistica.pdf');
    });
    // Función para actualizar estadísticas
    function updateStats() {
      const apiCount = apiData.length;
      document.getElementById('apiCount').textContent = apiCount;
    }
    
    // Función para cargar datos de la API al inicio
    async function loadAPIData() {
      console.log("=== INICIO loadAPIData ===");
      try {
        const data = await fetchAPIData();
        console.log("Datos obtenidos de fetchAPIData:", data);
        
        if (data && Array.isArray(data)) {
          apiData = mapAPIDataToTableFormat(data);
          console.log(`✅ Se cargaron ${apiData.length} registros de la API`);
          console.log("Datos mapeados:", apiData);
          
          updateStats();
          renderList();
        } else {
          console.log("❌ No se obtuvieron datos válidos de la API");
          console.log("Tipo de datos:", typeof data);
          console.log("Datos:", data);
        }
      } catch (error) {
        console.error("❌ Error en loadAPIData:", error);
        console.error("- Error Type:", error.constructor.name);
        console.error("- Error Message:", error.message);
        console.error("- Error Stack:", error.stack);
      } finally {
        console.log("=== FIN loadAPIData ===");
      }
    }
    
         // Evento para refrescar datos de la API
     document.getElementById('refreshAPI').addEventListener('click', async () => {
       const button = document.getElementById('refreshAPI');
       const originalText = button.textContent;
       button.textContent = '🔄 Cargando...';
       button.disabled = true;
       
       try {
         await loadAPIData();
         button.textContent = '✅ Actualizado';
         setTimeout(() => {
           button.textContent = originalText;
           button.disabled = false;
         }, 2000);
       } catch (error) {
         console.error('Error al refrescar datos:', error);
         button.textContent = '❌ Error';
         setTimeout(() => {
           button.textContent = originalText;
           button.disabled = false;
         }, 2000);
       }
     });
     
     // Evento para refrescar solo la tabla (sin cargar API)
     document.getElementById('refreshTable').addEventListener('click', () => {
       const button = document.getElementById('refreshTable');
       const originalText = button.textContent;
       button.textContent = '🔄 Actualizando...';
       button.disabled = true;
       
       try {
         renderList();
         button.textContent = '✅ Actualizado';
         setTimeout(() => {
           button.textContent = originalText;
           button.disabled = false;
         }, 1500);
       } catch (error) {
         console.error('Error al refrescar tabla:', error);
         button.textContent = '❌ Error';
         setTimeout(() => {
           button.textContent = originalText;
           button.disabled = false;
         }, 1500);
       }
     });
     

    
    // Aplicar filtros
    document.getElementById('applyFilter').addEventListener('click', () => {
      renderList();
    });
    
    // Render inicial y actualizar al cargar
    window.addEventListener('load', () => {
      loadAPIData(); // Cargar datos de la API al inicio
      renderList();
      updateStats(); // Actualizar estadísticas iniciales
    });
  </script>
</body>
</html>
