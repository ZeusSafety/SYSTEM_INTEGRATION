<!DOCTYPE html>
<!-- alias: logistica2025originalzeus | módulo: logística | STORAGE_KEY=incidencias_v12 -->
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Área de Logística: Registro de incidencia de proformas y actas</title>
  <style>
    :root{ --azul-oscuro:#17375d; --azul:#2f75b5; --gris:#f5f5f5; --rojo:#c00000; --link:#007bff; }
    body{ font-family: Arial, sans-serif; margin:0; background:var(--gris); }
    header{ display:flex; align-items:center; gap:.75rem; padding:.75rem 1rem; background:var(--azul-oscuro); color:#fff; }
    header h1{ margin:0; font-size:1.2rem; }
    .container{ max-width:1200px; margin:0 auto; padding:1rem; }
    .card{ background:#fff; border-radius:8px; box-shadow:0 6px 18px rgba(18,38,63,.08); margin-bottom:1.25rem; overflow:hidden; }
    .card-header{ background:var(--azul); color:#fff; padding:.75rem 1rem; display:flex; align-items:center; justify-content:space-between; }
    .card-header .btn-ghost{ display:flex; align-items:center; gap:.35rem; color:#fff; border-color:rgba(255,255,255,.65); }
    .card-header .btn-ghost:hover{ background:rgba(255,255,255,.08); }
    /* botón verde en header (como Guardar) */
    .card-header .btn-guardar{ display:flex; align-items:center; gap:.35rem; }
    .card-header .btn-ghost:hover{ background:rgba(255,255,255,.08); }
    .card-header h2{ margin:0; font-size:1.05rem; }
    .card-body{ padding:1rem; }

    .form-row{ display:flex; flex-wrap:wrap; gap:1rem; }
    .form-group{ flex:1 1 220px; display:flex; flex-direction:column; }
    .form-group label{ font-weight:bold; margin-bottom:.25rem; }
    .form-group input, .form-group select, .form-group textarea{ padding:.5rem; border:1px solid #ccc; border-radius:6px; font-size:.9rem; }
    .form-group textarea{ resize:vertical; }
    .muted{ color:#6b7280; font-size:.85rem; }

    .btn{ padding:.45rem .8rem; border:none; border-radius:6px; cursor:pointer; font-size:.85rem; }
    .btn-primary{ background:var(--azul-oscuro); color:#fff; }
    .btn-secondary{ background:var(--azul); color:#fff; }
    .btn-danger{ background:var(--rojo); color:#fff; }
    .btn-ghost{ background:transparent; border:1px solid #ddd; }

    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:.55rem; border:1px solid #e7e7e7; font-size:.85rem; vertical-align:top; }
    th{ background:var(--azul-oscuro); color:#fff; position:sticky; top:0; z-index:1; }
    td a{ color:var(--link); text-decoration:underline; cursor:pointer; }

    .badge{ padding:.2rem .5rem; border-radius:.25rem; color:#fff; font-size:.75rem; display:inline-block; }
    .badge-pendiente{ background:#ffc107; color:#000; }
    .badge-enrevision{ background:#ff9800; }
    .badge-notificado{ background:#17a2b8; }
    .badge-completado{ background:#4caf50; }
    .badge-observado{ background:#c00000; }

    .table-responsive{ overflow:auto; }

    .item-row{ display:flex; gap:.5rem; margin-bottom:.5rem; align-items:flex-start; }
    .item-row textarea{ flex:1 1 48%; min-height:44px; }
    .item-row .btn-danger{ height:36px; }

    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; justify-content:center; align-items:flex-start; padding-top:5%; z-index:1000; }
    .modal-content{ background:#fff; padding:1rem; border-radius:8px; width:92%; max-width:640px; max-height:80vh; overflow-y:auto; box-shadow:0 12px 32px rgba(0,0,0,.25); }
    .modal-close{ background:transparent; border:none; font-size:1.5rem; float:right; cursor:pointer; }

    .filter-row{ display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end; margin-bottom:.75rem; }
    .filter-group{ display:flex; flex-direction:column; font-size:.85rem; min-width:180px; }
    .filter-actions{ margin-left:auto; display:flex; gap:.5rem; align-items:center; }

    .cell-actions{ display:flex; gap:.5rem; align-items:center; }
    .icon-btn{ cursor:pointer; text-decoration:none; }
    .nowrap{ white-space:nowrap; }

    /* Column tweaks con reindexación por "Registrado por" */
    #tablaIncidencias th:nth-child(9),
    #tablaIncidencias td:nth-child(9){ min-width:110px; white-space:nowrap; text-align:center; }
    #tablaIncidencias th:nth-child(12),
    #tablaIncidencias td:nth-child(12){ min-width:160px; white-space:nowrap; }
    #tablaIncidencias th:nth-child(12),
    #tablaIncidencias td:nth-child(12){ white-space:nowrap; }
    #tablaIncidencias th:nth-child(7),
    #tablaIncidencias td:nth-child(7){ text-align:center; }
    #tablaIncidencias th:nth-child(9),
    #tablaIncidencias td:nth-child(9){ white-space:nowrap; text-align:center; }
    #tablaIncidencias td:nth-child(14){ text-transform:uppercase; }
    #tablaIncidencias th:nth-child(15),
    #tablaIncidencias td:nth-child(15){ text-align:center; }
    #tablaIncidencias td:nth-child(16){ text-transform:uppercase; }
    .cell-actions a{ text-decoration:none; }
    /* Centrar N° de comprobante (col 8) */
    #tablaIncidencias th:nth-child(8),
    #tablaIncidencias td:nth-child(8){ text-align:center; }
    #tablaIncidencias th:nth-child(20),
    #tablaIncidencias td:nth-child(20){ text-align:center; }

    #formLogistica button[type="submit"]{ margin-top:.5rem; }

    .prelike{ white-space:pre-wrap; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; padding:.5rem; }
  
    /* ====== TÍTULO PRINCIPAL ====== */
    .titulo-principal {
      background-color: #0056D2; /* Azul vivo */
      color: #FFFFFF;
      font-weight: bold;
      padding: 10px 15px;
      border-radius: 5px 5px 0 0;
    }
    /* ====== ENCABEZADO CUADRO "LISTADO DE INCIDENCIAS" ====== */
    .encabezado-listado {
      background-color: #0056D2; /* Azul vivo */
      color: #FFFFFF;
      font-weight: bold;
      padding: 8px 12px;
      border-radius: 5px 5px 0 0;
    }
    /* ====== ENCABEZADOS DE TABLA ====== */
    table thead th {
      background-color: #000000; /* Negro */
      color: #FFFFFF; /* Texto blanco */
      font-weight: bold;
      text-align: center;
      padding: 8px;
    }
    /* ====== BOTÓN GUARDAR INCIDENCIA ====== */
    .btn-guardar { background-color: #00B140; color: #FFFFFF; border: none; padding: 8px 14px; font-weight: bold; border-radius: 5px; transition: background-color 0.3s ease; }
    .btn-guardar:hover { background-color: #00913a; cursor: pointer; }
    /* ====== BOTÓN NEGRO (VER PROCEDIMIENTO) ====== */
    .btn-negro{ background-color:#000; color:#FFFFFF; border:none; padding:8px 14px; font-weight:bold; border-radius:5px; transition:background-color .3s ease; }
    .btn-negro:hover{ background-color:#222; cursor:pointer; }
    .card-header .btn-negro{ display:flex; align-items:center; gap:.35rem; }
    /* ====== BOTÓN ELIMINAR ====== */
    .btn-eliminar { background-color: #FF3B30; color: #FFFFFF; border: none; padding: 8px 14px; font-weight: bold; border-radius: 5px; transition: background-color 0.3s ease; }
    .btn-eliminar:hover { background-color: #d32d27; cursor: pointer; }
    /* ====== FONDO GENERAL ====== */
    body { background-color: #FFFFFF; color: #000000; }
  
    /* Botón azul corporativo reutilizable */
    .btn-azul{ background-color:#0056D2; color:#fff; border:none; }
    .btn-azul:hover{ filter:brightness(.92); cursor:pointer; }
  
    /* Botón claro para headers azules (outline) */
    .btn-outline-light{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,.75); border-radius:6px; padding:6px 12px; font-weight:600; display:inline-flex; align-items:center; gap:.35rem; transition:background .2s ease, border-color .2s ease; }
    .btn-outline-light:hover{ background:rgba(255,255,255,.12); border-color:#fff; }
  </style>
</head>
<body data-alias="logistica2025originalzeus" data-module="logistica">
  <header class="titulo-principal"><h1>Área de Logística: Registro de incidencia de proformas y actas</h1></header>

  <div class="container">
    <!-- Registrar nueva incidencia -->
    <div class="card">
      <div class="card-header encabezado-listado">
        <h2>Registrar nueva incidencia</h2>
        <button type="button" id="btnProcedimiento" class="btn btn-outline-light" title="Ver procedimiento">
          <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
            <path d="M20 22V6a2 2 0 0 0-2-2H6.5A2.5 2.5 0 0 0 4 6.5v13"/>
            <path d="M8 6v12"/>
            <path d="M12 6v12"/>
            <path d="M16 6v12"/>
          </svg>
          Ver procedimiento
        </button>
      </div>
      <div class="card-body">
        <form id="formLogistica">
          <div class="form-row">
            <div class="form-group">
              <label for="mes">Mes *</label>
              <select id="mes" required>
                <option value="">Seleccione...</option>
                <option>ENERO</option><option>FEBRERO</option><option>MARZO</option><option>ABRIL</option>
                <option>MAYO</option><option>JUNIO</option><option>JULIO</option><option>AGOSTO</option>
                <option>SETIEMBRE</option><option>OCTUBRE</option><option>NOVIEMBRE</option><option>DICIEMBRE</option>
              </select>
            </div>
            <div class="form-group">
              <label for="encargado">Encargado comprobante *</label>
              <select id="encargado" required>
                <option value="">Seleccione...</option>
                <option>HERVIN</option><option>KIMBERLY</option><option>JOSE</option><option>ALVARO</option><option>EVELYN</option><option>LIZETH</option>
              </select>
            </div>
            <div class="form-group">
              <label for="fechaEmision">Fecha de emisión *</label>
              <input type="date" id="fechaEmision" required />
            </div>
            <div class="form-group">
              <label for="responsable">Responsable incidencia *</label>
              <select id="responsable" required>
                <option value="">Seleccione...</option>
                <option>SANDRA</option><option>JOSE</option><option>KIMBERLY</option><option>JOSEPH</option>
                <option>MANUEL</option><option>JOSELYN</option><option>VICTOR</option><option>HERVIN</option><option>EVELYN</option>
              </select>
            </div>
            <div class="form-group">
              <label for="area">Área *</label>
              <select id="area" required>
                <option value="">Seleccione...</option>
                <option>VENTAS</option><option>FACTURACION</option><option>LOGISTICA</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="proforma">N° proforma o acta *</label>
              <input type="text" id="proforma" required />
            </div>
            <div class="form-group">
              <label for="comprobante">N° de comprobante *</label>
              <input type="text" id="comprobante" required />
            </div>
          </div>

          <div class="form-group">
            <label>Ítems de error (detalle / debe ser)</label>
            <div id="itemsContainer"></div>
            <button type="button" class="btn btn-secondary btn-azul" id="addItem">Agregar ítem</button>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="tipoIncidencia">Tipo de incidencia *</label>
              <select id="tipoIncidencia" required>
                <option value="">Seleccione...</option>
                <option>ERROR DE COLOR</option>
                <option>ERROR DE TALLA</option>
                <option>ERROR DE CANTIDAD</option>
                <option>ERROR DE PRECIO</option>
                <option>ERROR DE PRODUCTO</option>
                <option>OTROS</option>
              </select>
            </div>
            <div class="form-group">
              <label for="observacionDetalle">Observación detallada</label>
              <textarea id="observacionDetalle" placeholder="Describa la incidencia" disabled></textarea>
            </div>
          </div>

          <!-- Registrado por -->
          <div class="form-row">
            <div class="form-group" style="max-width:280px">
              <label for="registradoPor">Registrado por *</label>
              <select id="registradoPor" required>
                <option value="">Seleccione...</option>
                <option>JOSEPH</option>
                <option>JOSELYN</option>
                <option>OTROS</option>
              </select>
            </div>
            <div class="form-group" id="grpRegistradoOtro" style="max-width:260px; display:none">
              <label for="registradoPorOtro">Especifique</label>
              <input type="text" id="registradoPorOtro" placeholder="Nombre" />
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-guardar">Guardar incidencia</button>
        </form>
      </div>
    </div>

    <!-- Listado -->
    <div class="card">
      <div class="card-header encabezado-listado"><h2>Listado de incidencias</h2></div>
      <div class="card-body">
        <div class="filter-row">
          <div class="filter-group">
            <label for="filterEstado">Filtrar por verificación</label>
            <select id="filterEstado">
              <option value="TODOS">Todos</option>
              <option value="PENDIENTE">Pendiente</option>
              <option value="EN REVISIÓN">En revisión</option>
              <option value="NOTIFICADO">Notificado</option>
              <option value="COMPLETADO">Completado</option>
              <option value="OBSERVADO">Observado</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterStart">Desde</label>
            <input type="date" id="filterStart" />
          </div>
          <div class="filter-group">
            <label for="filterEnd">Hasta</label>
            <input type="date" id="filterEnd" />
          </div>
          <div class="filter-actions">
            <button id="applyFilter" class="btn btn-secondary btn-azul">Aplicar filtros</button>
            <button id="clearFilters" class="btn btn-ghost">Limpiar</button>
            <button id="exportCSV" class="btn btn-secondary btn-azul">Exportar CSV</button>
            <button id="generateReport" class="btn btn-secondary btn-azul">Generar reporte</button>
          </div>
        </div>

        <div class="table-responsive" id="tableViewport">
          <table id="tablaIncidencias">
            <thead>
              <tr>
                <th>ID</th>
                <th>Fecha registro</th>
                <th>Registrado por</th>
                <th>Mes</th>
                <th>Encargado comprobante</th>
                <th>Fecha emisión</th>
                <th>N° proforma/acta</th>
                <th>N° comprobante</th>
                <th>Ítems de error</th>
                <th>Responsable</th>
                <th>Área</th>
                <th>Tipo de incidencia</th>
                <th>Fecha de notificación</th>
                <th>Solución</th>
                <th>Obs. adicionales</th>
                <th>Revisado por</th>
                <th>Estado de verificación</th>
                <th>Fecha envío de archivo</th>
                <th>Archivo de solución</th>
                <th>Culminado</th>
                <th>Fecha concluyente</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modales -->
  <div id="detailModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeDetail" aria-label="Cerrar">&times;</button>
      <div id="detailContent"></div>
    </div>
  </div>

  <div id="archivoModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeArchivo" aria-label="Cerrar">&times;</button>
      <h3 style="margin-top:0">Actualizar envío y archivo de solución</h3>
      <p class="muted">Fecha y hora de envío: <strong>se registrará automáticamente al guardar</strong>.</p>
      <div class="form-group">
        <label for="editArchivoTexto">Texto/enlace del archivo (opcional)</label>
        <input type="url" id="editArchivoTexto" placeholder="Enlace público o nota" />
      </div>
      <div class="form-group">
        <label for="editArchivoPDF">Cargar PDF (opcional)</label>
        <input type="file" id="editArchivoPDF" accept="application/pdf" />
        <p class="muted">Si subes un PDF en esta PC (modo local), se guardará como DataURL. Tu sistema puede reemplazarlo por un enlace real.</p>
      </div>
      <div class="cell-actions">
        <button id="saveArchivo" class="btn btn-primary">Guardar</button>
        <button id="clearArchivo" class="btn btn-danger">Quitar archivo</button>
      </div>
    </div>
  </div>

  <div id="viewTextModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeViewText" aria-label="Cerrar">&times;</button>
      <h3 style="margin-top:0">Archivo de solución — texto/enlace</h3>
      <div id="viewArchivoContent"></div>
    </div>
  </div>

    <div id="procedimientoModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeProcedimiento" aria-label="Cerrar">&times;</button>
      <h3 style="margin-top:0">Procedimiento</h3>
      <p class="muted">Aquí puedes colocar el procedimiento (texto o enlace a PDF). Este contenido puede ser reemplazado por tu sistema.</p>
      <div class="prelike">1) Paso inicial
2) Paso intermedio
3) Paso final</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // ===== Datos base / almacenamiento =====
    const STORAGE_KEY='incidencias_v12';
    const SEQ_KEY='incidencias_seq_simple';

    const initialData=[{
      ID:'INC-SEED-0001', MES:'JULIO', 'ENCARGADO DE LA VENTA':'ALVARO', 'FECHA DE EMISION':'2025-07-18',
      'N° DE PROFORMA':'P-21077', 'N° DE COMPROBANTE':'NV-1814', RESPONSABLE:'SANDRA', AREA:'LOGISTICA',
      OBSERVACIONES:'ERROR DE PRODUCTO', OBSERVACION_DETALLE:'', 'FECHA NOTIFICACION':'2025-07-19T15:22:10',
      ESTADO:'COMPLETADO', 'SOLUCION DE COMPROBANTE':'SE EDITO', OBSERVACIONES_ADMIN:'Se coordinó con el cliente y se envió corrección.',
      'REVISADO POR':'KIMBERLY', 'ESTADO VERIFICACION':'COMPLETADO', 'FECHA ENVIO ARCHIVO':'2025-07-19T16:30:00',
      'ARCHIVO SOLUCION TEXTO':'https://ejemplo.com/solucion.pdf', 'ARCHIVO SOLUCION NOMBRE':'solucion.pdf', 'ARCHIVO SOLUCION DATAURL':'',
      CULMINADO:'SI', 'FECHA CONCLUYENTE':'2025-07-20T09:15:00', ITEMS:[{ 'DETALLE DE ERROR':'1DOC BADANA BLANCO NACIONAL', 'DEBE SER':'1 DOC BADANA BLANCO T9' }]
    }];

    const loadStored=()=>{ try{ const s=localStorage.getItem(STORAGE_KEY); return s?JSON.parse(s):[];}catch{ localStorage.removeItem(STORAGE_KEY); return [];} };
    const saveStored=(d)=>localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
    const nextId=()=>{ let seq=parseInt(localStorage.getItem(SEQ_KEY)||'0',10)+1; localStorage.setItem(SEQ_KEY,String(seq)); return `INC${String(seq).padStart(2,'0')}`; };
    const getAllRecords=()=>[...loadStored(), ...initialData];
    const findById=(id)=>getAllRecords().find(r=>r && r.ID===id)||null;
    const upsertStoredById=(rec)=>{ const s=loadStored(); const i=s.findIndex(r=>r && r.ID===rec.ID); if(i===-1) s.unshift(rec); else s[i]=rec; saveStored(s); };

    const badgeClass=(v)=>{ v=(v||'').toUpperCase(); return v==='PENDIENTE'?'badge-pendiente': v==='EN REVISIÓN'||v==='EN REVISION'||v==='EN PROCESO'?'badge-enrevision': v==='NOTIFICADO'?'badge-notificado': v==='COMPLETADO'?'badge-completado': v==='OBSERVADO'?'badge-observado':''; };
    const fmtDateDisplay=(dt)=>{ if(!dt) return ''; const d=new Date(dt); if(isNaN(d)) return dt; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); let hh=d.getHours(); const ap=hh>=12?'PM':'AM'; hh=hh%12||12; const mi=String(d.getMinutes()).padStart(2,'0'); const ss=String(d.getSeconds()).padStart(2,'0'); return `${dd}-${mm}-${yyyy} ${String(hh).padStart(2,'0')}:${mi}:${ss} ${ap}`; };
    const fmtDateOnly=(dt)=>{ if(!dt) return ''; const d=new Date(dt); if(isNaN(d)) return dt; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); return `${dd}/${mm}/${yyyy}`; };
    const nowLocalISO=()=>{ const d=new Date(); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); const HH=String(d.getHours()).padStart(2,'0'); const MI=String(d.getMinutes()).padStart(2,'0'); const SS=String(d.getSeconds()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}T${HH}:${MI}:${SS}`; };

    (function normalizeIDs(){ const s=loadStored(); let ch=false; let max=parseInt(localStorage.getItem(SEQ_KEY)||'0',10); s.forEach(r=>{ if(r && !r.ID){ max++; r.ID=`INC${String(max).padStart(2,'0')}`; ch=true; }}); if(ch){ localStorage.setItem(SEQ_KEY,String(max)); saveStored(s);} initialData.forEach(r=>{ if(r && !r.ID){ max++; r.ID=`INC${String(max).padStart(2,'0')}`; } }); })();

    const ALIASES={ ID:['ID'], FECHA_REGISTRO:['FECHA REGISTRO','FECHA_REGISTRO','FECHA DE REGISTRO'], REGISTRADO_POR:['REGISTRADO POR','REGISTRADO_POR'], MES:['MES'], ENCARGADO:['ENCARGADO DE LA VENTA','ENCARGADO DE COMPROBANTE'], FECHA_EMISION:['FECHA DE EMISION','FECHA EMISION'], N_PROFORMA:['N° DE PROFORMA','N° PROFORMA O ACTA','N° PROFORMA','N° PROFORMA/ACTA'], N_COMPROBANTE:['N° DE COMPROBANTE','N° COMPROBANTE'], ITEMS:['ITEMS'], RESPONSABLE:['RESPONSABLE'], AREA:['AREA'], TIPO:['OBSERVACIONES','TIPO DE INCIDENCIA'], FECHA_NOTIF:['FECHA NOTIFICACION','FECHA DE NOTIFICACION','FECHA DE NOTIFICACIÓN'], SOLUCION:['SOLUCION DE COMPROBANTE','SOLUCION'], OBS_ADMIN:['OBSERVACIONES_ADMIN','OBS. ADICIONALES','OBSERVACIONES ADICIONALES'], REVISADO:['REVISADO POR'], ESTADO_VERIF:['ESTADO VERIFICACION','ESTADO DE VERIFICACION','ESTADO DE VERIFICACIÓN','ESTADO'], FECHA_ENVIO:['FECHA ENVIO ARCHIVO','FECHA DE ENVIO DE ARCHIVO','FECHA ENVIO DE ARCHIVO'], ARCHIVO_TEXTO:['ARCHIVO SOLUCION TEXTO'], ARCHIVO_NOMBRE:['ARCHIVO SOLUCION NOMBRE'], ARCHIVO_DATAURL:['ARCHIVO SOLUCION DATAURL'], CULMINADO:['CULMINADO'], FECHA_CONCLUYENTE:['FECHA CONCLUYENTE','FECHA CONCLUYENTE ADMIN','FECHA CONCLUYENTE (ADMINISTRACION)','FECHA CONCLUYENTE (ADMINISTRACIÓN)'] };
    const pick=(rec,keys,allowEmpty=true)=>{ for(const k of keys){ if(Object.prototype.hasOwnProperty.call(rec,k)){ const val=rec[k]; if(val!=null && (allowEmpty || String(val).trim()!=='')) return val; } } return ''; };
    const v=(rec,key,opts)=>pick(rec, (ALIASES[key]||[key]), (opts?.allowEmpty??true));
    const norm=(s)=> (s||'').toUpperCase().replace(/[ÁÀÂÄ]/g,'A').replace(/[ÉÈÊË]/g,'E').replace(/[ÍÌÎÏ]/g,'I').replace(/[ÓÒÔÖ]/g,'O').replace(/[ÚÙÛÜ]/g,'U');

    const filterRecords=()=>{
      const estadoSel=document.getElementById('filterEstado').value;
      const start=document.getElementById('filterStart').value;
      const end=document.getElementById('filterEnd').value;
      return getAllRecords().filter(rec=>{
        const est=v(rec,'ESTADO_VERIF')||'PENDIENTE';
        if(estadoSel!=='TODOS' && norm(est)!==norm(estadoSel)) return false;
        const fISO=v(rec,'FECHA_EMISION')||''; const f=typeof fISO==='string'? fISO.substring(0,10):'';
        if(start && (!f || f<start)) return false; if(end && (!f || f>end)) return false; return true;
      });
    };

    const tdText=(text)=>{ const td=document.createElement('td'); td.textContent=text==null?'':String(text); return td; };
    const tdHTML=(node)=>{ const td=document.createElement('td'); td.appendChild(node); return td; };
    const spanNowrap=(text)=>{ const s=document.createElement('span'); s.className='nowrap'; s.textContent=text||''; return s; };

    const itemsCell=(rec)=>{ const td=document.createElement('td'); const arr=v(rec,'ITEMS'); const has=Array.isArray(arr)&&arr.length>0; if(!has){ td.textContent='Sin items'; return td; } const eye=document.createElement('a'); eye.href='#'; eye.textContent='👁️'; eye.className='icon-btn'; eye.title='Ver ítems'; eye.dataset.action='view'; eye.dataset.id=v(rec,'ID'); const pdf=document.createElement('a'); pdf.href='#'; pdf.textContent='PDF'; pdf.className='icon-btn'; pdf.dataset.action='pdf'; pdf.dataset.id=v(rec,'ID'); td.append(eye, document.createTextNode(' '), pdf); return td; };

    const archivoCell=(rec)=>{ const td=document.createElement('td'); const box=document.createElement('div'); box.className='cell-actions'; const hasText=!!String(v(rec,'ARCHIVO_TEXTO')).trim(); const hasPdf=!!v(rec,'ARCHIVO_DATAURL'); if(hasText){ const a=document.createElement('a'); a.href='#'; a.textContent='Ver'; a.className='icon-btn'; a.dataset.action='view-text'; a.dataset.id=v(rec,'ID'); box.appendChild(a);} if(hasPdf){ if(box.children.length) box.appendChild(document.createTextNode(' / ')); const a=document.createElement('a'); a.href=v(rec,'ARCHIVO_DATAURL'); a.textContent='PDF'; a.setAttribute('download', v(rec,'ARCHIVO_NOMBRE')||'archivo.pdf'); box.appendChild(a);} if(!box.children.length){ box.appendChild(document.createTextNode('—')); } const btn=document.createElement('button'); btn.className='btn btn-ghost'; btn.textContent='Editar'; btn.dataset.action='edit-file'; btn.dataset.id=v(rec,'ID'); box.appendChild(document.createTextNode(' ')); box.appendChild(btn); td.appendChild(box); return td; };

    function renderList(){
      const tbody=document.querySelector('#tablaIncidencias tbody'); tbody.innerHTML='';
      const filtered=filterRecords();
      filtered.forEach(rec=>{
        const tr=document.createElement('tr'); const id=v(rec,'ID');
        tr.appendChild(tdText(id));
        tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(v(rec,'FECHA_REGISTRO'))||'')));
        tr.appendChild(tdText(v(rec,'REGISTRADO_POR')));
        tr.appendChild(tdText(v(rec,'MES')));
        tr.appendChild(tdText(v(rec,'ENCARGADO')));
        tr.appendChild(tdHTML(spanNowrap(fmtDateOnly(v(rec,'FECHA_EMISION'))||'')));
        tr.appendChild(tdText(v(rec,'N_PROFORMA')));
        tr.appendChild(tdText(v(rec,'N_COMPROBANTE')));
        tr.appendChild(itemsCell(rec));
        tr.appendChild(tdText(v(rec,'RESPONSABLE')));
        tr.appendChild(tdText(v(rec,'AREA')));
        tr.appendChild(tdText(v(rec,'TIPO')));
        tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(v(rec,'FECHA_NOTIF'))||'')));
        tr.appendChild(tdHTML(spanNowrap(v(rec,'SOLUCION')||'')));
        const tdObs=document.createElement('td'); const txt=String(v(rec,'OBS_ADMIN')||'').trim(); if(txt){ const a=document.createElement('a'); a.href='#'; a.textContent='👁️'; a.className='icon-btn'; a.dataset.action='view-obs-log'; a.dataset.id=id; tdObs.appendChild(a);} else tdObs.textContent='—'; tr.appendChild(tdObs);
        tr.appendChild(tdText(v(rec,'REVISADO')));
        const est=String(v(rec,'ESTADO_VERIF')||'').toUpperCase(); const badge=document.createElement('span'); badge.className=`badge ${badgeClass(est)}`; badge.textContent=est; tr.appendChild(tdHTML(badge));
        tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(v(rec,'FECHA_ENVIO'))||'')));
        tr.appendChild(archivoCell(rec));
        tr.appendChild(tdText(v(rec,'CULMINADO')||'NO'));
        tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(v(rec,'FECHA_CONCLUYENTE')||''))));
        tbody.appendChild(tr);
      });

      document.querySelector('#tablaIncidencias').onclick=(e)=>{
        const t=e.target.closest('a,button'); if(!t) return; const action=t.dataset.action; const id=t.dataset.id||'';
        if(action==='view'){ e.preventDefault(); showDetailById(id); }
        if(action==='pdf'){ e.preventDefault(); generatePDFById(id); }
        if(action==='edit-file'){ e.preventDefault(); openArchivoModalById(id); }
        if(action==='view-text'){ e.preventDefault(); openViewTextModalById(id); }
        if(action==='view-obs-log'){ e.preventDefault(); openObsModalById_Log(id); }
      };

      adjustTableViewport();
    }

    function adjustTableViewport(){
      const wrapper=document.getElementById('tableViewport'); const table=document.getElementById('tablaIncidencias'); if(!wrapper||!table) return;
      const thH=table.tHead? table.tHead.getBoundingClientRect().height:40; const firstRow=table.tBodies[0]?.rows[0]; const rowH=firstRow? firstRow.getBoundingClientRect().height:40; const maxH=Math.round(thH+rowH*10+2); wrapper.style.maxHeight=maxH+'px'; wrapper.style.overflow='auto';
    }

    function showDetailById(id){ const rec=findById(id); if(!rec){ alert('No se encontró el registro.'); return; } const c=document.getElementById('detailContent'); c.innerHTML=''; const fields=[["ID",v(rec,'ID')],["Fecha de registro",fmtDateDisplay(v(rec,'FECHA_REGISTRO'))||''],["Registrado por",v(rec,'REGISTRADO_POR')||''],["Mes",v(rec,'MES')],["Encargado comprobante",v(rec,'ENCARGADO')],["Fecha de emisión",fmtDateOnly(v(rec,'FECHA_EMISION'))],["N° proforma/acta",v(rec,'N_PROFORMA')],["N° de comprobante",v(rec,'N_COMPROBANTE')],["Responsable",v(rec,'RESPONSABLE')],["Área",v(rec,'AREA')||''],["Tipo de incidencia",v(rec,'TIPO')||''],["Fecha de notificación",fmtDateOnly(v(rec,'FECHA_NOTIF')||'')],["Solución",v(rec,'SOLUCION')||''],["Obs. adicionales",v(rec,'OBS_ADMIN')||''],["Revisado por",v(rec,'REVISADO')||''],["Estado de verificación",v(rec,'ESTADO_VERIF')||''],["Fecha envío de archivo",fmtDateDisplay(v(rec,'FECHA_ENVIO')||'')],["Culminado",v(rec,'CULMINADO')||'NO'],["Fecha concluyente",fmtDateDisplay(v(rec,'FECHA_CONCLUYENTE')||'')]]; fields.forEach(([l,vv])=>{ const p=document.createElement('p'); p.innerHTML=`<strong>${l}:</strong> ${vv||''}`; c.appendChild(p); }); const items=v(rec,'ITEMS'); if(items&&items.length){ const ul=document.createElement('ul'); items.forEach((it,i)=>{ const li=document.createElement('li'); li.innerHTML=`<strong>Detalle ${i+1}:</strong> ${it['DETALLE DE ERROR']||''}<br><strong>Debe ser ${i+1}:</strong> ${it['DEBE SER']||''}`; ul.appendChild(li); }); c.appendChild(ul);} document.getElementById('detailModal').style.display='flex'; }
    document.getElementById('closeDetail').onclick=()=>{ document.getElementById('detailModal').style.display='none'; };

    let CURRENT_EDIT_ID=null;
    const openArchivoModalById=(id)=>{ CURRENT_EDIT_ID=id; const rec=findById(id); if(!rec){ alert('No se encontró el registro.'); return; } document.getElementById('editArchivoTexto').value=String(v(rec,'ARCHIVO_TEXTO')||''); document.getElementById('editArchivoPDF').value=''; document.getElementById('archivoModal').style.display='flex'; };
    document.getElementById('closeArchivo').onclick=()=>{ document.getElementById('archivoModal').style.display='none'; };
    document.getElementById('clearArchivo').onclick=()=>{ if(!CURRENT_EDIT_ID) return; const rec=findById(CURRENT_EDIT_ID); if(!rec) return; rec['ARCHIVO SOLUCION TEXTO']=''; rec['ARCHIVO SOLUCION NOMBRE']=''; rec['ARCHIVO SOLUCION DATAURL']=''; upsertStoredById(rec); document.getElementById('archivoModal').style.display='none'; renderList(); };
    document.getElementById('saveArchivo').onclick=async()=>{ if(!CURRENT_EDIT_ID) return; const rec=findById(CURRENT_EDIT_ID); if(!rec){ alert('No se encontró el registro.'); return; } const txt=String(document.getElementById('editArchivoTexto').value||'').trim(); const fileInput=document.getElementById('editArchivoPDF'); const file=fileInput.files && fileInput.files[0] ? fileInput.files[0] : null; rec['ARCHIVO SOLUCION TEXTO']=txt; if(file){ try{ if(file.arrayBuffer){ const buf=await file.arrayBuffer(); const b64=btoa(String.fromCharCode(...new Uint8Array(buf))); rec['ARCHIVO SOLUCION DATAURL']=`data:${file.type};base64,${b64}`; rec['ARCHIVO SOLUCION NOMBRE']=file.name; }else{ await new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>{ rec['ARCHIVO SOLUCION DATAURL']=fr.result; rec['ARCHIVO SOLUCION NOMBRE']=file.name; resolve(); }; fr.onerror=reject; fr.readAsDataURL(file); }); } }catch(err){ console.error('Error leyendo PDF:', err); alert('No se pudo leer el PDF seleccionado.'); return; } } rec['FECHA ENVIO ARCHIVO']=nowLocalISO(); upsertStoredById(rec); document.getElementById('archivoModal').style.display='none'; renderList(); };

    const openViewTextModalById=(id)=>{ const rec=findById(id); if(!rec){ alert('No se encontró el registro.'); return; } const cont=document.getElementById('viewArchivoContent'); cont.innerHTML=''; const txt=String(v(rec,'ARCHIVO_TEXTO')||'').trim(); if(!txt){ cont.textContent='(Sin texto/enlace)'; } else if(/^https?:\/\//i.test(txt)){ const a=document.createElement('a'); a.href=txt; a.target='_blank'; a.textContent=txt; cont.appendChild(a);} else { const pre=document.createElement('div'); pre.className='prelike'; pre.textContent=txt; cont.appendChild(pre);} document.getElementById('viewTextModal').style.display='flex'; };
    document.getElementById('closeViewText').onclick=()=>{ document.getElementById('viewTextModal').style.display='none'; };

    const openObsModalById_Log=(id)=>{ const rec=findById(id); if(!rec){ alert('No se encontró el registro.'); return; } const cont=document.getElementById('viewArchivoContent'); cont.innerHTML=''; const pre=document.createElement('div'); pre.className='prelike'; pre.textContent=String(v(rec,'OBS_ADMIN')||'').trim()||'(Sin observaciones)'; cont.appendChild(pre); document.getElementById('viewTextModal').style.display='flex'; };

    async function generatePDFById(id){ const rec=findById(id); if(!rec){ alert('No se encontró el registro.'); return; } const { jsPDF }=window.jspdf; const doc=new jsPDF(); const lines=[`ID: ${v(rec,'ID')}`,`Fecha registro: ${fmtDateDisplay(v(rec,'FECHA_REGISTRO'))}`,`Registrado por: ${v(rec,'REGISTRADO_POR')}`,`Mes: ${v(rec,'MES')}`,`Encargado: ${v(rec,'ENCARGADO')}`,`Fecha de emisión: ${fmtDateOnly(v(rec,'FECHA_EMISION'))}`,`N° proforma/acta: ${v(rec,'N_PROFORMA')}`,`N° comprobante: ${v(rec,'N_COMPROBANTE')}`,`Responsable: ${v(rec,'RESPONSABLE')}`,`Área: ${v(rec,'AREA')}`,`Tipo: ${v(rec,'TIPO')}`,`Fecha notificación: ${fmtDateDisplay(v(rec,'FECHA_NOTIF'))}`,`Solución: ${v(rec,'SOLUCION')}`,`Obs. adicionales: ${(v(rec,'OBS_ADMIN')||'').toString().replace(/\n/g,' ')}`,`Revisado por: ${v(rec,'REVISADO')}`,`Estado verificación: ${v(rec,'ESTADO_VERIF')}`,`Fecha envío archivo: ${fmtDateDisplay(v(rec,'FECHA_ENVIO'))}`,`Fecha concluyente: ${v(rec,'FECHA_CONCLUYENTE')?fmtDateDisplay(v(rec,'FECHA_CONCLUYENTE')):''}`]; let y=10; doc.setFontSize(12); lines.forEach(line=>{ doc.text(line,10,y); y+=7; if(y>280){ doc.addPage(); y=10; } }); const items=v(rec,'ITEMS')||[]; items.forEach((it,i)=>{ doc.text(`Detalle ${i+1}: ${it['DETALLE DE ERROR']||''}`,10,y); y+=7; if(y>280){ doc.addPage(); y=10; } doc.text(`Debe ser ${i+1}: ${it['DEBE SER']||''}`,10,y); y+=7; if(y>280){ doc.addPage(); y=10; } }); doc.save(`${v(rec,'ID')||'incidencia'}.pdf`); }

    function exportFilteredCSV(){ const list=filterRecords(); let csv='ID,FECHA REGISTRO,REGISTRADO POR,MES,ENCARGADO COMPROBANTE,FECHA DE EMISION,N° PROFORMA O ACTA,N° DE COMPROBANTE,DETALLE DE ERROR,DEBE SER,RESPONSABLE,AREA,TIPO,FECHA DE NOTIFICACION,SOLUCION,OBS. ADICIONALES,REVISADO POR,ESTADO DE VERIFICACION,FECHA ENVIO DE ARCHIVO,ARCHIVO TEXTO,ARCHIVO NOMBRE,CULMINADO,FECHA CONCLUYENTE\n'; list.forEach(rec=>{ const items=(v(rec,'ITEMS')&&v(rec,'ITEMS').length)?v(rec,'ITEMS'):[{'DETALLE DE ERROR':'','DEBE SER':''}]; items.forEach(item=>{ const row=[ v(rec,'ID')||'', v(rec,'FECHA_REGISTRO')||'', v(rec,'REGISTRADO_POR')||'', v(rec,'MES')||'', v(rec,'ENCARGADO')||'', v(rec,'FECHA_EMISION')||'', v(rec,'N_PROFORMA')||'', v(rec,'N_COMPROBANTE')||'', item['DETALLE DE ERROR']||'', item['DEBE SER']||'', v(rec,'RESPONSABLE')||'', v(rec,'AREA')||'', v(rec,'TIPO')||'', v(rec,'FECHA_NOTIF')||'', v(rec,'SOLUCION')||'', v(rec,'OBS_ADMIN')||'', v(rec,'REVISADO')||'', v(rec,'ESTADO_VERIF')||'', v(rec,'FECHA_ENVIO')||'', v(rec,'ARCHIVO_TEXTO')||'', v(rec,'ARCHIVO_NOMBRE')||'', v(rec,'CULMINADO')||'', v(rec,'FECHA_CONCLUYENTE')||'' ]; csv += row.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',') + '\n'; }); }); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='incidencias_logistica.csv'; a.click(); URL.revokeObjectURL(url); }

    async function generateReport(){ const table=document.querySelector('#tablaIncidencias'); const canvas=await html2canvas(table); const img=canvas.toDataURL('image/png'); const { jsPDF }=window.jspdf; const pdf=new jsPDF({orientation:'landscape'}); const props=pdf.getImageProperties(img); const pdfW=pdf.internal.pageSize.getWidth(); const pdfH=(props.height*pdfW)/props.width; pdf.addImage(img,'PNG',0,10,pdfW,pdfH); pdf.save('reporte_incidencias_logistica.pdf'); }

    // ===== Items: agregar/eliminar =====
    function addItemRow(){ const c=document.getElementById('itemsContainer'); const row=document.createElement('div'); row.className='item-row'; const t1=document.createElement('textarea'); t1.placeholder='Detalle de error'; const t2=document.createElement('textarea'); t2.placeholder='Debe ser'; const del=document.createElement('button'); del.type='button'; del.className='btn btn-danger btn-eliminar'; del.textContent='Eliminar'; del.setAttribute('aria-label','Eliminar ítem'); del.dataset.action='del-item'; row.append(t1,t2,del); c.appendChild(row); }
    document.getElementById('addItem').onclick=addItemRow;
    document.getElementById('itemsContainer').addEventListener('click',(e)=>{ const btn=e.target.closest('button[data-action="del-item"]'); if(!btn) return; const container=document.getElementById('itemsContainer'); const rows=container.querySelectorAll('.item-row'); const row=btn.closest('.item-row'); if(rows.length>1){ const next=row.nextElementSibling?.querySelector('textarea')||container.querySelector('.item-row textarea'); row.remove(); if(next) next.focus(); } else { row.querySelectorAll('textarea').forEach(t=>t.value=''); row.querySelector('textarea')?.focus(); } });

    // ===== Form interacciones =====
    document.getElementById('tipoIncidencia').addEventListener('change',(e)=>{ const val=e.target.value; const d=document.getElementById('observacionDetalle'); d.disabled=(val!=='OTROS'); if(val!=='OTROS') d.value=''; });
    (function(){ const sel=document.getElementById('registradoPor'); const grp=document.getElementById('grpRegistradoOtro'); const txt=document.getElementById('registradoPorOtro'); if(sel&&grp&&txt){ sel.addEventListener('change',(e)=>{ const isOtros=e.target.value==='OTROS'; grp.style.display=isOtros?'block':'none'; txt.required=isOtros; if(!isOtros) txt.value=''; }); } })();

    // ===== Filtros/listado =====
    document.getElementById('applyFilter').onclick=()=>renderList();
    document.getElementById('clearFilters').onclick=()=>{ document.getElementById('filterEstado').value='TODOS'; document.getElementById('filterStart').value=''; document.getElementById('filterEnd').value=''; renderList(); };
    document.getElementById('exportCSV').onclick=exportFilteredCSV;
    document.getElementById('generateReport').onclick=generateReport;

    // Cerrar modales clic fuera
    ;['viewTextModal','detailModal','archivoModal','procedimientoModal'].forEach(id=>{ const overlay=document.getElementById(id); if(overlay){ overlay.addEventListener('click',(e)=>{ if(e.target===overlay) overlay.style.display='none'; }); } });

    // Botón "Ver procedimiento" (abre/cierra modal)
    (function(){
      const btn=document.getElementById('btnProcedimiento');
      const close=document.getElementById('closeProcedimiento');
      if(btn){ btn.addEventListener('click', ()=>{ const m=document.getElementById('procedimientoModal'); if(m) m.style.display='flex'; }); }
      if(close){ close.addEventListener('click', ()=>{ const m=document.getElementById('procedimientoModal'); if(m) m.style.display='none'; }); }
    })();

    // ===== Guardar incidencia =====
    document.getElementById('formLogistica').addEventListener('submit',(e)=>{
      e.preventDefault();
      const mes=document.getElementById('mes').value;
      const encargado=document.getElementById('encargado').value;
      const fechaEmision=document.getElementById('fechaEmision').value;
      const responsable=document.getElementById('responsable').value;
      const area=document.getElementById('area').value;
      const proforma=document.getElementById('proforma').value;
      const comprobante=document.getElementById('comprobante').value;
      const tipo=document.getElementById('tipoIncidencia').value;
      const obsDetalle=document.getElementById('observacionDetalle').value;
      const registradoSel=document.getElementById('registradoPor').value;
      const registradoOtro=(document.getElementById('registradoPorOtro').value||'').trim();
      const registradoPor=(registradoSel==='OTROS')?registradoOtro:registradoSel;
      if(!mes||!encargado||!fechaEmision||!responsable||!area||!proforma||!comprobante||!tipo||!registradoPor){ alert('Completa los campos obligatorios.'); return; }
      const id=nextId(); const items=[]; document.querySelectorAll('#itemsContainer .item-row').forEach(r=>{ const a=r.querySelector('textarea:nth-child(1)').value.trim(); const b=r.querySelector('textarea:nth-child(2)').value.trim(); if(a||b) items.push({'DETALLE DE ERROR':a,'DEBE SER':b}); });
      const rec={ ID:id, 'FECHA REGISTRO':nowLocalISO(), 'REGISTRADO POR':registradoPor, MES:mes, 'ENCARGADO DE COMPROBANTE':encargado, 'FECHA DE EMISION':fechaEmision, 'N° PROFORMA O ACTA':proforma, 'N° DE COMPROBANTE':comprobante, RESPONSABLE:responsable, AREA:area, 'TIPO DE INCIDENCIA':tipo, OBSERVACION_DETALLE:obsDetalle, ITEMS:items, 'FECHA NOTIFICACION':'', SOLUCION:'', OBSERVACIONES_ADMIN:'', 'REVISADO POR':'', 'ESTADO VERIFICACION':'PENDIENTE', 'FECHA ENVIO ARCHIVO':'', 'ARCHIVO SOLUCION TEXTO':'', 'ARCHIVO SOLUCION NOMBRE':'', 'ARCHIVO SOLUCION DATAURL':'', CULMINADO:'NO', 'FECHA CONCLUYENTE':'' };
      upsertStoredById(rec);
      e.target.reset(); document.getElementById('observacionDetalle').disabled=true; document.getElementById('itemsContainer').innerHTML=''; addItemRow();
      const grp=document.getElementById('grpRegistradoOtro'); if(grp){ grp.style.display='none'; document.getElementById('registradoPorOtro').value=''; }
      renderList();
    });

    // Inicial
    addItemRow();
    renderList();
    window.addEventListener('resize',adjustTableViewport);
    window.addEventListener('storage',(ev)=>{ if(ev.key===STORAGE_KEY) renderList(); });
  </script>
</body>
</html>
