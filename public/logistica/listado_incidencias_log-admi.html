<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Área de Administración: Gestión de incidencias (v12)</title>
  <style>
    /* Importar Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #1e293b;
      line-height: 1.6;
    }
    
    /* Header mejorado */
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #17375d 0%, #1e4d7a 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(23, 55, 93, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      opacity: 0.3;
    }
    
    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
      position: relative;
      z-index: 1;
      letter-spacing: -0.025em;
    }
    
    /* Botón volver mejorado */
    .btn-back {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(100, 116, 139, 0.3);
      margin: 1rem 0 0 1rem;
    }
    
    .btn-back:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(100, 116, 139, 0.4);
    }
    
    /* Container principal */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    /* Cards mejoradas */
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
      overflow: hidden;
      border: 1px solid rgba(226, 232, 240, 0.8);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
    }
    
    .card-header {
      background: linear-gradient(135deg, #2f75b5 0%, #1e4d7a 100%);
      color: white;
      padding: 1.5rem 2rem;
      position: relative;
      overflow: hidden;
    }
    
    .card-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
      animation: shimmer 3s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .card-header h2 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      position: relative;
      z-index: 1;
    }
    
    .card-body {
      padding: 2rem;
    }
    
    /* Botones mejorados */
    .btn {
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      font-family: inherit;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #17375d 0%, #1e4d7a 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(23, 55, 93, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(23, 55, 93, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #4f81bd 0%, #3b6aa0 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(79, 129, 189, 0.3);
    }
    
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 129, 189, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
    }
    
    .btn-edit {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }
    
    .btn-edit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
    }
    
    .btn-edit[disabled] {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: #adb5bd;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 2px 8px rgba(108, 117, 125, 0.2);
    }
    
    /* Tabla mejorada */
    .table-responsive {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }
    
    th {
      background: linear-gradient(135deg, #17375d 0%, #1e4d7a 100%);
      color: white;
      padding: 1rem;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border: none;
    }
    
    td {
      padding: 1rem;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }
    
    tr:hover td {
      background-color: #f8fafc;
    }
    
    td:nth-child(3),
    td:nth-child(9),
    td:nth-child(10) {
      white-space: nowrap;
    }
    
    /* Enlaces mejorados */
    .link-view, .link-pdf {
      color: #2f75b5;
      text-decoration: none;
      cursor: pointer;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      background: rgba(47, 117, 181, 0.1);
      transition: all 0.3s ease;
      display: inline-block;
      margin-right: 0.5rem;
    }
    
    .link-view:hover, .link-pdf:hover {
      background: rgba(47, 117, 181, 0.2);
      transform: translateY(-1px);
    }
    
    /* Badges mejorados */
    .badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: inline-block;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .badge-pendiente {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .badge-enproceso {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    }
    
    .badge-completado {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    /* Filtros mejorados */
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: end;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }
    
    .filter-group label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #374151;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .filter-group input,
    .filter-group select {
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: white;
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #2f75b5;
      box-shadow: 0 0 0 3px rgba(47, 117, 181, 0.1);
    }
    
    /* Modal mejorado */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 2rem;
    }
    
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 100px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(226, 232, 240, 0.8);
    }
    
    .modal-close {
      background: transparent;
      border: none;
      font-size: 2rem;
      float: right;
      cursor: pointer;
      color: #64748b;
      transition: color 0.3s ease;
      margin-bottom: 1rem;
    }
    
    .modal-close:hover {
      color: #1e293b;
    }
    
    /* Formulario mejorado */
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #374151;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: all 0.3s ease;
      background: white;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #2f75b5;
      box-shadow: 0 0 0 3px rgba(47, 117, 181, 0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .card-body {
        padding: 1.5rem;
      }
      
      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .modal-content {
        padding: 1.5rem;
        margin: 1rem;
      }
    }
    
    /* Animaciones suaves */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
      animation: fadeIn 0.6s ease-out;
    }
    
    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #17375d 0%, #2f75b5 100%);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #1e4d7a 0%, #1e4d7a 100%);
    }
  </style>
</head>
<body>
  <header>
    <h1>Área de Administración: Gestión de incidencias</h1>
  </header>

  <button onclick="window.top.location.href='<?= ScriptApp.getService().getUrl() ?>?page=admin'" class="btn-back">
              <i class="bi bi-arrow-left"></i> Volver
            </button>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h2>Listado de incidencias</h2>
      </div>
      <div class="card-body">
        <!-- Filtros y acciones -->
        <div class="filter-row">
          <div class="filter-group">
            <label for="filterEstadoAdmin">Filtrar por estado</label>
            <select id="filterEstadoAdmin">
              <option value="TODOS">Todos</option>
              <option value="PENDIENTE">Pendiente</option>
              <option value="EN PROCESO">En proceso</option>
              <option value="COMPLETADO">Completado</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterStartAdmin">Desde</label>
            <input type="date" id="filterStartAdmin" />
          </div>
          <div class="filter-group">
            <label for="filterEndAdmin">Hasta</label>
            <input type="date" id="filterEndAdmin" />
          </div>
          <div class="filter-group" style="margin-top:1.25rem;">
            <button id="applyFilterAdmin" class="btn btn-secondary">Aplicar filtros</button>
          </div>
          <div style="margin-left:auto; display:flex; gap:0.5rem; align-items:center;">
            <button id="exportCSV" class="btn btn-secondary">Exportar CSV</button>
            <button id="generateReportAdmin" class="btn btn-secondary">Generar reporte</button>
          </div>
        </div>
        <div class="table-responsive">
          <table id="tablaAdmin">
            <thead>
              <tr>
                <th>Mes</th>
                <th>Encargado</th>
                <th>Fecha emisión</th>
                <th>N° proforma</th>
                <th>N° comprobante</th>
                <th>Ítems</th>
                <th>Responsable</th>
                <th>Área</th>
                <th>Tipo de incidencia</th>
                <th>Fecha corrección</th>
                <th>Estado</th>
                <th>Solución</th>
                <th>Obs. adicionales</th>
                <th>Modificado por</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal detalle -->
  <div id="detailModalAdmin" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeDetailAdmin">&times;</button>
      <div id="detailContentAdmin"></div>
    </div>
  </div>
  <!-- Modal edición -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeEdit">&times;</button>
      <h3 style="color: #17375d; font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; border-bottom: 3px solid #17375d; padding-bottom: 1rem;">Editar incidencia</h3>
      <div class="form-group">
        <label for="editEstado">Estado</label>
        <select id="editEstado">
          <option value="PENDIENTE">Pendiente</option>
          <option value="EN PROCESO">En proceso</option>
          <option value="COMPLETADO">Completado</option>
        </select>
      </div>
      <div class="form-group">
        <label for="editFecha">Fecha de corrección</label>
        <input type="date" id="editFecha" />
      </div>
      <div class="form-group">
        <label for="editSolucion">Solución de comprobante</label>
        <select id="editSolucion">
          <option value="">Seleccione...</option>
          <option value="SE ANULO">SE ANULO</option>
          <option value="SE MODIFICO">SE MODIFICO</option>
        </select>
      </div>
      <div class="form-group">
        <label for="editObservaciones">Observaciones adicionales</label>
        <textarea id="editObservaciones"></textarea>
      </div>
      <div class="form-group">
        <label for="editModificadoPor">Modificado por</label>
        <select id="editModificadoPor">
          <option value="">Seleccione...</option>
          <option value="KIMBERLY">Kimberly</option>
          <option value="HERVIN">Hervin</option>
          <option value="SANDRA">Sandra</option>
          <option value="EVELYN">Evelyn</option>
        </select>
      </div>
      <div style="text-align: right; margin-top: 2rem;">
        <button id="saveEdit" class="btn btn-primary">Guardar cambios</button>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Datos importados de Excel
    const initialData = [
      {
        
      },
      {
        "MES": "",
        "ENCARGADO DE LA VENTA": "",
        "FECHA DE EMISION": "",
        "N° DE PROFORMA": "",
        "N° DE COMPROBANTE": "",
        "RESPONSABLE": "",
        "AREA": "",
        "OBSERVACIONES": "",
        "OBSERVACION_DETALLE": "",
        "FECHA DE CORRECCION ": "",
        "ESTADO": "",
        "SOLUCION DE COMPROBANTE": "",
        "OBSERVACIONES_ADMIN": "",
        "MODIFICADO POR": "",
        "ITEMS": []
      }
    ];
    const STORAGE_KEY = 'incidencias_v12';
    function loadStored() {
      const s = localStorage.getItem(STORAGE_KEY);
      return s ? JSON.parse(s) : [];
    }
    function saveStored(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    // Obtener clase de badge según estado
    function badgeClass(val) {
      const v = (val || '').toUpperCase();
      if (v === 'PENDIENTE') return 'badge-pendiente';
      if (v === 'EN PROCESO') return 'badge-enproceso';
      if (v === 'COMPLETADO') return 'badge-completado';
      return '';
    }
    // Renderizar tabla
    function renderTable() {
      const tbody = document.querySelector('#tablaAdmin tbody');
      tbody.innerHTML = '';
      // Ordenar: incidencias locales primero (últimas primero) y luego las importadas
      const local = loadStored();
      const all = [...local, ...initialData];
      const estadoFiltro = document.getElementById('filterEstadoAdmin').value;
      const start = document.getElementById('filterStartAdmin').value;
      const end = document.getElementById('filterEndAdmin').value;
      all.forEach((rec, idx) => {
        const estado = rec['ESTADO'] || '';
        // Filtrar por estado
        if (estadoFiltro !== 'TODOS' && estado.toUpperCase() !== estadoFiltro) return;
        // Filtrar por fecha
        if (start) {
          const fecha = (rec['FECHA DE EMISION'] || '').substring(0, 10);
          if (!fecha || fecha < start) return;
        }
        if (end) {
          const fecha = (rec['FECHA DE EMISION'] || '').substring(0, 10);
          if (!fecha || fecha > end) return;
        }
        const tr = document.createElement('tr');
        const cells = [
          rec['MES'] || '',
          rec['ENCARGADO DE LA VENTA'] || '',
          rec['FECHA DE EMISION'] || '',
          rec['N° DE PROFORMA'] || '',
          rec['N° DE COMPROBANTE'] || '',
          (rec['ITEMS'] && rec['ITEMS'].length ? '<span class="link-view" data-index="' + idx + '">Ver</span> <a href="#" class="link-pdf" data-index="' + idx + '">PDF</a>' : ''),
          rec['RESPONSABLE'] || '',
          rec['AREA'] || '',
          rec['OBSERVACIONES'] || '',
          rec['FECHA DE CORRECCION '] || '',
          '<span class="badge ' + badgeClass(estado) + '">' + (estado || '') + '</span>',
          rec['SOLUCION DE COMPROBANTE'] || '',
          rec['OBSERVACIONES_ADMIN'] || '',
          rec['MODIFICADO POR'] || '',
          ''
        ];
        cells.forEach((html) => {
          const td = document.createElement('td');
          td.innerHTML = html;
          tr.appendChild(td);
        });
        // Acción editar
        const actionTd = tr.lastChild;
        // Sólo editable si pertenece a local (indice < local.length)
        if (idx < local.length) {
          const btn = document.createElement('button');
          btn.textContent = 'Editar';
          btn.className = 'btn btn-edit';
          btn.dataset.index = idx;
          btn.addEventListener('click', () => openEdit(idx));
          actionTd.appendChild(btn);
        } else {
          const btn = document.createElement('button');
          btn.textContent = 'Editar';
          btn.className = 'btn btn-edit';
          btn.disabled = true;
          actionTd.appendChild(btn);
        }
        tbody.appendChild(tr);
      });
      // Agregar eventos a enlaces de vista y PDF
      document.querySelectorAll('.link-view').forEach((link) => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          const i = parseInt(this.dataset.index);
          showDetail(i);
        });
      });
      document.querySelectorAll('.link-pdf').forEach((link) => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          const i = parseInt(this.dataset.index);
          generatePDF(i);
        });
      });
    }
    // Mostrar detalles en modal
    function showDetail(index) {
      // Utilizar el mismo orden que la tabla: incidencias locales primero y luego las importadas
      const all = [...loadStored(), ...initialData];
      const rec = all[index];
      const container = document.getElementById('detailContentAdmin');
      container.innerHTML = '';
      const fields = [
        ['Mes', rec['MES']],
        ['Encargado', rec['ENCARGADO DE LA VENTA']],
        ['Fecha de emisión', rec['FECHA DE EMISION']],
        ['N° de proforma', rec['N° DE PROFORMA']],
        ['N° de comprobante', rec['N° DE COMPROBANTE']],
        ['Responsable', rec['RESPONSABLE']],
        ['Área', rec['AREA'] || ''],
        ['Estado', rec['ESTADO']],
        ['Fecha corrección', rec['FECHA DE CORRECCION '] || ''],
        ['Solución comprobante', rec['SOLUCION DE COMPROBANTE'] || ''],
        ['Tipo de incidencia', rec['OBSERVACIONES'] || ''],
        ['Observación detallada', rec['OBSERVACION_DETALLE'] || ''],
        ['Observaciones adicionales', rec['OBSERVACIONES_ADMIN'] || ''],
        ['Modificado por', rec['MODIFICADO POR'] || '']
      ];
      fields.forEach(([label, value]) => {
        const p = document.createElement('p');
        p.innerHTML = '<strong>' + label + ':</strong> ' + (value || '');
        container.appendChild(p);
      });
      if (rec['ITEMS'] && rec['ITEMS'].length) {
        const ul = document.createElement('ul');
        rec['ITEMS'].forEach((it) => {
          const li = document.createElement('li');
          li.innerHTML = '<strong>Detalle:</strong> ' + (it['DETALLE DE ERROR'] || '') + '<br><strong>Debe ser:</strong> ' + (it['DEBE SER'] || '');
          ul.appendChild(li);
        });
        container.appendChild(ul);
      }
      document.getElementById('detailModalAdmin').style.display = 'flex';
    }
    document.getElementById('closeDetailAdmin').addEventListener('click', () => {
      document.getElementById('detailModalAdmin').style.display = 'none';
    });
    // Variables para editar
    let currentEditIndex = null;
    function openEdit(idx) {
      currentEditIndex = idx;
      const stored = loadStored();
      const rec = stored[idx];
      document.getElementById('editEstado').value = rec['ESTADO'] || 'PENDIENTE';
      document.getElementById('editFecha').value = rec['FECHA DE CORRECCION '] || '';
      document.getElementById('editSolucion').value = rec['SOLUCION DE COMPROBANTE'] || '';
      document.getElementById('editObservaciones').value = rec['OBSERVACIONES_ADMIN'] || '';
      document.getElementById('editModificadoPor').value = rec['MODIFICADO POR'] || '';
      document.getElementById('editModal').style.display = 'flex';
    }
    document.getElementById('closeEdit').addEventListener('click', () => {
      document.getElementById('editModal').style.display = 'none';
    });
    document.getElementById('saveEdit').addEventListener('click', () => {
      if (currentEditIndex === null) return;
      const stored = loadStored();
      const rec = stored[currentEditIndex];
      rec['ESTADO'] = document.getElementById('editEstado').value;
      // Combinar la fecha seleccionada con la hora actual para registrar con hora
      const fechaCorreccion = document.getElementById('editFecha').value;
      rec['FECHA DE CORRECCION '] = fechaCorreccion ? (fechaCorreccion + ' ' + new Date().toLocaleTimeString()) : '';
      rec['SOLUCION DE COMPROBANTE'] = document.getElementById('editSolucion').value;
      rec['OBSERVACIONES_ADMIN'] = document.getElementById('editObservaciones').value;
      rec['MODIFICADO POR'] = document.getElementById('editModificadoPor').value;
      stored[currentEditIndex] = rec;
      saveStored(stored);
      document.getElementById('editModal').style.display = 'none';
      renderTable();
    });
    // Generar PDF
    function generatePDF(index) {
      const all = [...initialData, ...loadStored()];
      const rec = all[index];
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.setFontSize(14);
      doc.text('Detalle de Incidencia', 105, y, { align: 'center' });
      y += 10;
      doc.setFontSize(10);
        const entries = [
        ['Mes', rec['MES']],
        ['Encargado', rec['ENCARGADO DE LA VENTA']],
        ['Fecha de emisión', rec['FECHA DE EMISION']],
        ['N° de proforma', rec['N° DE PROFORMA']],
        ['N° de comprobante', rec['N° DE COMPROBANTE']],
        ['Responsable', rec['RESPONSABLE']],
        ['Área', rec['AREA'] || ''],
        ['Estado', rec['ESTADO']],
        ['Fecha corrección', rec['FECHA DE CORRECCION '] || ''],
        ['Solución comprobante', rec['SOLUCION DE COMPROBANTE'] || ''],
        ['Tipo de incidencia', rec['OBSERVACIONES'] || ''],
        ['Observación detallada', rec['OBSERVACION_DETALLE'] || ''],
        ['Observaciones adicionales', rec['OBSERVACIONES_ADMIN'] || ''],
        ['Modificado por', rec['MODIFICADO POR'] || '']
      ];
      entries.forEach(([label, value]) => {
        doc.text(`${label}: ${value || ''}`, 10, y);
        y += 6;
      });
      if (rec['ITEMS'] && rec['ITEMS'].length) {
        y += 4;
        doc.text('Ítems:', 10, y);
        y += 6;
        rec['ITEMS'].forEach((item, indexItem) => {
          doc.text(`Detalle ${indexItem + 1}: ${item['DETALLE DE ERROR'] || ''}`, 10, y);
          y += 6;
          doc.text(`Debe ser ${indexItem + 1}: ${item['DEBE SER'] || ''}`, 10, y);
          y += 6;
        });
      }
      doc.save(`incidencia_${rec['N° DE PROFORMA'] || 'detalle'}.pdf`);
    }

    // Genera un informe PDF de todas las incidencias registradas según el filtro actual, capturando la tabla como imagen
    function generateReportAdmin() {
      const table = document.querySelector('#tablaAdmin');
      if (!table) return;
      html2canvas(table).then((canvas) => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'pt', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const imgWidth = pageWidth - 20;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        const finalHeight = imgHeight > pageHeight - 20 ? pageHeight - 20 : imgHeight;
        const finalWidth = imgHeight > pageHeight - 20 ? (canvas.width * finalHeight / canvas.height) : imgWidth;
        const x = (pageWidth - finalWidth) / 2;
        const y = 10;
        doc.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
        doc.save('reporte_incidencias_admin.pdf');
      });
    }
    // Exportar CSV
    document.getElementById('exportCSV').addEventListener('click', () => {
      const all = [...initialData, ...loadStored()];
      let csv = 'MES,ENCARGADO DE LA VENTA,FECHA DE EMISION,N° DE PROFORMA,N° DE COMPROBANTE,DETALLE DE ERROR,DEBE SER,RESPONSABLE,AREA,TIPO DE INCIDENCIA,OBSERVACION DETALLADA,FECHA DE CORRECCION,ESTADO,SOLUCION DE COMPROBANTE,OBSERVACIONES ADICIONALES,MODIFICADO POR\n';
      all.forEach((rec) => {
        const items = rec['ITEMS'] && rec['ITEMS'].length ? rec['ITEMS'] : [{ 'DETALLE DE ERROR': '', 'DEBE SER': '' }];
        items.forEach((item) => {
        const row = [
          rec['MES'] || '',
          rec['ENCARGADO DE LA VENTA'] || '',
          rec['FECHA DE EMISION'] || '',
          rec['N° DE PROFORMA'] || '',
          rec['N° DE COMPROBANTE'] || '',
          item['DETALLE DE ERROR'] || '',
          item['DEBE SER'] || '',
          rec['RESPONSABLE'] || '',
          rec['AREA'] || '',
          rec['OBSERVACIONES'] || '',
          rec['OBSERVACION_DETALLE'] || '',
          rec['FECHA DE CORRECCION '] || '',
          rec['ESTADO'] || '',
          rec['SOLUCION DE COMPROBANTE'] || '',
          rec['OBSERVACIONES_ADMIN'] || '',
          rec['MODIFICADO POR'] || ''
        ];
          csv += row.map((x) => '"' + (x || '').replace(/"/g, '""') + '"').join(',') + '\n';
        });
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'incidencias_admin.csv';
      a.click();
      URL.revokeObjectURL(url);
    });
    // Aplicar filtros en administración
    document.getElementById('applyFilterAdmin').addEventListener('click', () => {
      renderTable();
    });

    // Generar reporte PDF de todas las incidencias en administración
    document.getElementById('generateReportAdmin').addEventListener('click', generateReportAdmin);
    // Inicializar
    window.addEventListener('load', renderTable);
    window.addEventListener('storage', () => renderTable());
  </script>
</body>
</html>
