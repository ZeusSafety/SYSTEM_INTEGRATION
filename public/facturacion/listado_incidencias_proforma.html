<!DOCTYPE html>
<!-- alias: FACTURACION2025ORIGINALZEUS | m√≥dulo: facturaci√≥n | STORAGE_KEY=incidencias_v12 -->
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>√Årea de Facturaci√≥n: Listado de incidencia de comprobantes y actas</title>
  <style>
    :root{
      --azul:#0056D2;           /* azul vivo (coherente con log√≠stica/administraci√≥n) */
      --negro:#000000;           /* encabezado de tabla */
      --gris:#FFFFFF;            /* fondo general blanco */
      --rojo:#FF3B30;            /* eliminar / alerta */
      --verde:#00B140;           /* guardar/ok */
      --link:#0056D2;            /* enlaces dentro de celdas */
      --amarillo:#ffc107; --naranja:#ff9800; --celeste:#17a2b8; --verde-suave:#4caf50;
    }
    body{ font-family:Arial, sans-serif; margin:0; background:var(--gris); color:#000; }
    header.titulo-principal{ background:var(--azul); color:#fff; font-weight:bold; padding:10px 15px; border-radius:5px 5px 0 0; text-align:left; }

    .container{ max-width:1400px; margin:0 auto; padding:1rem; }
    .card{ background:#fff; border-radius:8px; box-shadow:0 6px 18px rgba(18,38,63,.08); margin-bottom:1.25rem; overflow:hidden; }
    .card-header{ background:var(--azul); color:#fff; padding:.75rem 1rem; display:flex; align-items:center; justify-content:space-between; }
    .card-header h2{ margin:0; font-size:1.05rem; }
    .card-body{ padding:1rem; }

    /* Filtros como log√≠stica/administraci√≥n */
    .filter-row{ display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end; margin-bottom:.75rem; }
    .filter-group{ display:flex; flex-direction:column; font-size:.85rem; min-width:180px; }
    .filter-actions{ margin-left:auto; display:flex; gap:.5rem; align-items:center; }

    .btn{ padding:.45rem .8rem; border:none; border-radius:6px; cursor:pointer; font-size:.85rem; }
    .btn-azul{ background:var(--azul); color:#fff; }
    .btn-azul:hover{ filter:brightness(.92); }
    .btn-ghost{ background:transparent; border:1px solid #ddd; }
    .btn-ok{ background:var(--verde); color:#fff; }
    .btn-danger{ background:var(--rojo); color:#fff; }
    .btn-outline-light{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,.75); border-radius:6px; padding:6px 12px; font-weight:600; display:inline-flex; align-items:center; gap:.35rem; }
    .btn-outline-light:hover{ background:rgba(255,255,255,.12); border-color:#fff; }

    .table-responsive{ overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    thead th{ background:var(--negro); color:#fff; text-align:center; padding:8px; position:sticky; top:0; z-index:1; }
    th, td{ padding:.55rem; border:1px solid #e7e7e7; font-size:.85rem; vertical-align:top; }

    td a{ color:var(--link); text-decoration:none; cursor:pointer; } /* sin subrayado (üëÅÔ∏è / PDF) */
    .nowrap{ white-space:nowrap; }
    .inline-row{ display:inline-flex; align-items:center; gap:.5rem; white-space:nowrap; }
    .cell-actions{ display:flex; gap:.5rem; align-items:center; }

    /* Badges (Administraci√≥n) */
    .badge{ padding:.2rem .5rem; border-radius:.25rem; color:#fff; font-size:.75rem; display:inline-block; }
    .badge-pendiente{ background:var(--amarillo); color:#000; }
    .badge-enrevision{ background:var(--naranja); }
    .badge-notificado{ background:var(--celeste); }
    .badge-completado{ background:var(--verde-suave); }
    .badge-observado{ background:#c00000; }

    /* Estado de soluci√≥n (Facturaci√≥n) */
    .badge-sol-pendiente{ background:var(--amarillo); color:#000; }
    .badge-sol-realizado{ background:var(--verde); }

    /* Alineaciones espec√≠ficas por √≠ndice (tras agregar 2 columnas) */
    /* 7: N¬∞ proforma/acta | 8: N¬∞ comprobante | 9: √çtems | 10: Tipo */
    #tablaFact th:nth-child(7), #tablaFact td:nth-child(7){ text-align:center; }
    #tablaFact th:nth-child(8), #tablaFact td:nth-child(8){ text-align:center; }
    #tablaFact th:nth-child(9), #tablaFact td:nth-child(9){ text-align:center; }
    #tablaFact th:nth-child(10), #tablaFact td:nth-child(10){ text-align:center; text-transform:uppercase; }
    /* 12: Soluci√≥n (texto) */
    #tablaFact th:nth-child(12), #tablaFact td:nth-child(12){ text-align:center; text-transform:uppercase; }
    /* 14: Revisado por */
    #tablaFact th:nth-child(14), #tablaFact td:nth-child(14){ text-align:center; text-transform:uppercase; }
    /* 21: Estado de soluci√≥n (badge+editar) */
    #tablaFact th:nth-child(21), #tablaFact td:nth-child(21){ min-width:220px; white-space:nowrap; }
    /* 22: Culminado centrado */
    #tablaFact th:nth-child(22), #tablaFact td:nth-child(22){ text-align:center; }

    /* Modales */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; justify-content:center; align-items:flex-start; padding-top:5%; z-index:1000; }
    .modal-content{ background:#fff; padding:1rem; border-radius:8px; width:92%; max-width:640px; max-height:80vh; overflow-y:auto; box-shadow:0 12px 32px rgba(0,0,0,.25); }
    .modal-close{ background:transparent; border:none; font-size:1.5rem; float:right; cursor:pointer; }
    .form-group{ display:flex; flex-direction:column; margin-bottom:.75rem; }
    .form-group label{ font-weight:bold; margin-bottom:.25rem; }
    .form-group input, .form-group select, .form-group textarea{ padding:.5rem; border:1px solid #ccc; border-radius:6px; font-size:.9rem; }
    .muted{ color:#6b7280; font-size:.85rem; }
    .prelike{ white-space:pre-wrap; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; padding:.5rem; }
  </style>
</head>
<body>
  <header class="titulo-principal">√Årea de Facturaci√≥n: Listado de incidencia de comprobantes y actas</header>

  <div class="container">
    <div class="card">
      <div class="card-header">
        <h2>Listado de incidencias</h2>
        <button type="button" id="btnProcedimiento" class="btn btn-outline-light" title="Ver procedimiento">
          <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M20 22V6a2 2 0 0 0-2-2H6.5A2.5 2.5 0 0 0 4 6.5v13"/><path d="M8 6v12"/><path d="M12 6v12"/><path d="M16 6v12"/></svg>
          Ver procedimiento
        </button>
      </div>
      <div class="card-body">
        <!-- Filtros (como log√≠stica/administraci√≥n) -->
        <div class="filter-row">
          <div class="filter-group">
            <label for="filterEstado">Filtrar por verificaci√≥n</label>
            <select id="filterEstado">
              <option value="TODOS">Todos</option>
              <option value="PENDIENTE">Pendiente</option>
              <option value="EN REVISI√ìN">En revisi√≥n</option>
              <option value="NOTIFICADO">Notificado</option>
              <option value="COMPLETADO">Completado</option>
              <option value="OBSERVADO">Observado</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterStart">Desde</label>
            <input type="date" id="filterStart" />
          </div>
          <div class="filter-group">
            <label for="filterEnd">Hasta</label>
            <input type="date" id="filterEnd" />
          </div>
          <div class="filter-actions">
            <button id="applyFilter" class="btn btn-azul">Aplicar filtros</button>
            <button id="clearFilters" class="btn btn-ghost">Limpiar</button>
            <button id="exportCSV" class="btn btn-azul">Exportar CSV</button>
            <button id="generateReport" class="btn btn-azul">Generar reporte</button>
          </div>
        </div>

        <div class="table-responsive" id="tableViewport">
          <table id="tablaFact">
            <thead>
              <tr>
                <th>ID</th>
                <th>Fecha de registro</th>
                <th>Registrado por</th>
                <th>Mes</th>
                <th>Encargado comprobante</th>
                <th>Fecha de emisi√≥n</th>
                <th>N¬∞ proforma/acta</th>
                <th>N¬∞ comprobante</th>
                <th>√çtems de error</th>
                <th>Tipo de incidencia</th>
                <th>Fecha de notificaci√≥n</th>
                <th>Soluci√≥n</th>
                <th>Obs. adicionales</th>
                <th>Revisado por</th>
                <th>Estado de verificaci√≥n</th>
                <th>Fecha env√≠o de archivo</th>
                <th>Archivo de soluci√≥n</th>
                <th>Fecha de correcci√≥n</th>
                <th>Comprobante</th>
                <th>N¬∞ de comprobante</th>
                <th>Estado de soluci√≥n</th>
                <th>Culminado</th>
                <th>Fecha concluyente</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modales b√°sicos -->
  <div id="detailModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeDetail" aria-label="Cerrar">&times;</button>
      <div id="detailContent"></div>
    </div>
  </div>

  <div id="viewTextModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeViewText" aria-label="Cerrar">&times;</button>
      <h3 style="margin-top:0">Archivo de soluci√≥n ‚Äî texto/enlace</h3>
      <div id="viewArchivoContent"></div>
    </div>
  </div>

  <div id="procedimientoModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeProcedimiento" aria-label="Cerrar">&times;</button>
      <h3 style="margin-top:0">Procedimiento</h3>
      <div class="prelike">1) Paso inicial\n2) Paso intermedio\n3) Paso final</div>
    </div>
  </div>

  <!-- Modal: Editar Estado de soluci√≥n (Facturaci√≥n) -->
  <div id="estadoSolModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeEstadoSol" aria-label="Cerrar">&times;</button>
      <h3 style="margin-top:0">Actualizar estado de soluci√≥n</h3>
      <p class="muted">Fecha de correcci√≥n: <strong>se registrar√° autom√°ticamente al guardar</strong>.</p>
      <div class="form-group">
        <label for="fTipoComprobante">Comprobante</label>
        <select id="fTipoComprobante">
          <option value="">Seleccione...</option>
          <option>factura</option>
          <option>boleta</option>
          <option>nota de venta</option>
          <option>acta</option>
        </select>
      </div>
      <div class="form-group">
        <label for="fNumeroComprobante">N¬∞ de comprobante</label>
        <input type="text" id="fNumeroComprobante" placeholder="Ej. F001-123456" />
      </div>
      <div class="form-group">
        <label for="fEstadoSolucion">Estado de soluci√≥n</label>
        <select id="fEstadoSolucion">
          <option value="">Seleccione...</option>
          <option>Pendiente</option>
          <option>Realizado</option>
        </select>
      </div>
      <div class="inline-row">
        <button id="saveEstadoSol" class="btn btn-ok">Guardar</button>
        <button id="cancelEstadoSol" class="btn btn-ghost">Cancelar</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // ====== API Configuration ======
    const API_BASE_URL = 'https://incidenciaslogisticaproformas-2946605267.us-central1.run.app';
    const API_HEADERS = { "Content-Type": "application/json" };
    
    // ====== API Methods ======
    const apiGet = async (params = {}) => {
      try {
        const url = new URL(API_BASE_URL);
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
        
        const response = await fetch(url, {
          method: 'GET',
          headers: API_HEADERS
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('Error en API GET:', error);
        return [];
      }
    };

    const apiPost = async (data) => {
      try {
        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: API_HEADERS,
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('Error en API POST:', error);
        return null;
      }
    };

    const apiPut = async (data, params = {}) => {
      try {
        const url = new URL(API_BASE_URL);
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
        
        const response = await fetch(url, {
          method: 'PUT',
          headers: API_HEADERS,
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('Error en API PUT:', error);
        return null;
      }
    };

    // ====== Data Management ======
    let allRecords = [];
    const loadRecords = async () => {
      try {
        console.log('üîÑ Cargando registros desde API...');
        const data = await apiGet({ tipo: "facturacion" });
        console.log('üìä Datos recibidos de API:', data);
        allRecords = Array.isArray(data) ? data : [];
        console.log('‚úÖ Registros cargados:', allRecords.length);
        console.log('üìã Primer registro (ejemplo):', allRecords[0]);
        return allRecords;
      } catch (error) {
        console.error('‚ùå Error cargando registros:', error);
        allRecords = [];
        return [];
      }
    };

    const getAllRecords = () => [...allRecords];
    const findById = (id) => {
      console.log('üîç Buscando registro con ID:', id);
      console.log('üìã Total de registros disponibles:', allRecords.length);
      console.log('üìã IDs disponibles:', allRecords.map(r => r?.ID).slice(0, 5));
      
      const found = getAllRecords().find(r => r && r.ID == id) || null;
      console.log('üéØ Registro encontrado:', found);
      return found;
    };

    // ====== Fechas ======
    const fmtDateDisplay=(dt)=>{ if(!dt) return ''; const d=new Date(dt); if(isNaN(d)) return dt; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); let hh=d.getHours(); const ap=hh>=12?'PM':'AM'; hh=hh%12||12; const mi=String(d.getMinutes()).padStart(2,'0'); const ss=String(d.getSeconds()).padStart(2,'0'); return `${dd}-${mm}-${yyyy} ${String(hh).padStart(2,'0')}:${mi}:${ss} ${ap}`; };
    const fmtDateOnly=(dt)=>{ if(!dt) return ''; const d=new Date(dt); if(isNaN(d)) return dt; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); return `${dd}/${mm}/${yyyy}`; };
    const nowLocalISO=()=>{ const d=new Date(); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); const HH=String(d.getHours()).padStart(2,'0'); const MI=String(d.getMinutes()).padStart(2,'0'); const SS=String(d.getSeconds()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}T${HH}:${MI}:${SS}`; };
    
    // ====== Mes a texto ======
    const getMonthName = (monthNum) => {
      const months = [
        '', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
      ];
      const num = parseInt(monthNum) || 0;
      return months[num] || monthNum;
    };

    // ====== Badges ======
    const badgeVerifClass=(v)=>{ const s=(v||'').toUpperCase(); if(s==='PENDIENTE')return 'badge-pendiente'; if(s==='EN REVISI√ìN'||s==='EN REVISION')return 'badge-enrevision'; if(s==='NOTIFICADO')return 'badge-notificado'; if(s==='COMPLETADO')return 'badge-completado'; if(s==='OBSERVADO')return 'badge-observado'; return 'badge-pendiente'; };
    const badgeSolClass=(v)=>{ const s=(v||'').toUpperCase(); if(s==='PENDIENTE')return 'badge-sol-pendiente'; if(s==='REALIZADO')return 'badge-sol-realizado'; return 'badge-sol-pendiente'; };

    // ====== Helpers de celda ======
    const tdText=(t)=>{ const td=document.createElement('td'); td.textContent=t==null?'':String(t); return td; };
    const tdHTML=(n)=>{ const td=document.createElement('td'); td.appendChild(n); return td; };
    const spanNowrap=(t)=>{ const s=document.createElement('span'); s.className='nowrap'; s.textContent=t||''; return s; };

    const itemsCell=(rec)=>{ 
      const td=document.createElement('td'); 
      td.style.textAlign='center';
      
      // Crear ojo para ver detalles
      const eye=document.createElement('a'); 
      eye.href='#'; 
      eye.textContent='üëÅÔ∏è'; 
      eye.dataset.action='view'; 
      eye.dataset.id=rec.ID;
      eye.style.marginRight='10px';
      
      // Crear enlace PDF
      const pdf=document.createElement('a'); 
      pdf.href='#'; 
      pdf.textContent='PDF'; 
      pdf.dataset.action='pdf'; 
      pdf.dataset.id=rec.ID;
      
      td.append(eye, pdf); 
      return td; 
    };

    const archivoCellReadOnly=(rec)=>{ 
      const td=document.createElement('td'); 
      td.style.textAlign='center';
      
      const archivoUrl = rec['ARCHIVO_SOLUCION_PDF'];
      const hasArchivo = archivoUrl && String(archivoUrl).trim();
      
      if(hasArchivo){
        const btn = document.createElement('button');
        btn.className = 'btn btn-azul';
        btn.textContent = 'Ver archivo';
        btn.style.fontSize = '0.75rem';
        btn.style.padding = '0.25rem 0.5rem';
        btn.onclick = (e) => {
          e.preventDefault();
          openViewTextModalById(rec.ID);
        };
        td.appendChild(btn);
      } else {
        td.textContent = '‚Äî';
      }
      
      return td; 
    };

    const estadoSolCell=(rec)=>{ 
      const td=document.createElement('td'); 
      const box=document.createElement('div'); 
      box.className='cell-actions'; 
      const estado=(rec['ESTADO_SOLUCION']||'').toString(); 
      const badge=document.createElement('span'); 
      badge.className=`badge ${badgeSolClass(estado)}`; 
      badge.textContent=(estado||'').toUpperCase()||'PENDIENTE'; 
      const btn=document.createElement('button'); 
      btn.className=( (estado||'').toUpperCase()==='REALIZADO' ? 'btn btn-ok':'btn btn-danger'); 
      btn.textContent='Editar'; 
      btn.dataset.action='edit-sol'; 
      btn.dataset.id=rec.ID; 
      box.append(badge, btn); 
      td.appendChild(box); 
      return td; 
    };

    // ====== Filtros & render ======
    const filterRecords=()=>{ const estadoSel=document.getElementById('filterEstado')?.value||'TODOS'; const start=document.getElementById('filterStart')?.value||''; const end=document.getElementById('filterEnd')?.value||''; return getAllRecords().filter(rec=>{ const est=(rec['ESTADO_INCIDENCIA']||'PENDIENTE').toString().toUpperCase(); if(estadoSel!=='TODOS' && est!==estadoSel) return false; const fISO=rec['DATE(FECHA_EMISION)']||''; const f=typeof fISO==='string'? fISO.substring(0,10):''; if(start && (!f||f<start)) return false; if(end && (!f||f>end)) return false; return true; }); };

    const renderList=()=>{ 
      console.log('üîÑ Renderizando lista...');
      const tbody=document.querySelector('#tablaFact tbody'); 
      tbody.innerHTML=''; 
      const filteredRecords = filterRecords();
      console.log('üìä Registros filtrados:', filteredRecords.length);
      
      filteredRecords.forEach(rec=>{ 
        console.log('üìã Renderizando registro ID:', rec['ID'], 'Campos disponibles:', Object.keys(rec));
        const tr=document.createElement('tr'); 
        tr.appendChild(tdText(rec['ID']||'')); 
        tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['FECHA_REGISTRO'])||''))); 
        tr.appendChild(tdText(rec['REGISTRADO_POR']||'')); 
        tr.appendChild(tdText(getMonthName(rec['MONTH(FECHA_EMISION)'])||'')); 
        tr.appendChild(tdText(rec['ENCARGADO_COMPROBANTE']||'')); 
        tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['DATE(FECHA_EMISION)'])||''))); 
        tr.appendChild(tdText(rec['NUMERO_PROFORMA']||'')); 
        tr.appendChild(tdText(rec['NUMERO_COMPROBANTE']||'')); 
        tr.appendChild(itemsCell(rec)); 
        const tipo=(rec['TIPO_INCIDENCIA']||''); 
        tr.appendChild(tdText(tipo?String(tipo).toUpperCase():'')); 
        tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['FECHA_NOTIFICACION'])||''))); 
        tr.appendChild(tdHTML(spanNowrap((rec['SOLUCION']||'').toString().toUpperCase()))); 
        tr.appendChild(tdText((rec['OBSERVACION_ADICIONAL_CORRECION']||'').trim())); 
        tr.appendChild(tdText((rec['REVISADO_POR']||'').toString().toUpperCase())); 
        { const tdV=document.createElement('td'); const est=(rec['ESTADO_INCIDENCIA']||'').toUpperCase(); const badge=document.createElement('span'); badge.className=`badge ${badgeVerifClass(est)}`; badge.textContent=est||''; tdV.appendChild(badge); tr.appendChild(tdV); } 
        tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['FECHA_ENVIO_ARCHIVO'])||''))); 
        tr.appendChild(archivoCellReadOnly(rec)); 
        tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['FECHA_CORRECION'])||''))); 
        tr.appendChild(tdText(rec['COMPROBANTE']||'')); 
        tr.appendChild(tdText(rec['NUMERO_COMPROBANTE_SOLUCION']||'')); 
        tr.appendChild(estadoSolCell(rec)); 
        tr.appendChild(tdText((rec['CULMINADO']||'NO').toUpperCase())); 
        tr.appendChild(tdHTML(spanNowrap(fmtDateDisplay(rec['FECHA_CONCLUYENTE']||'')))); 
        tbody.appendChild(tr); 
      }); 
      console.log('‚úÖ Lista renderizada');
      adjustTableHeightToRows(10); 
    };

    // Altura: 10 filas visibles
    const adjustTableHeightToRows=(n)=>{ try{ const table=document.getElementById('tablaFact'); if(!table) return; const cont=document.getElementById('tableViewport'); const thead=table.tHead; const tbody=table.tBodies[0]; if(!thead||!tbody) return; const rows=tbody.rows; if(!rows||!rows.length){ cont.style.maxHeight=''; cont.style.overflow=''; return; } const headerH=thead.getBoundingClientRect().height||40; const rowH=rows[0].getBoundingClientRect().height||40; const visible=Math.min(n, rows.length); const maxH=Math.ceil(headerH + rowH*visible + 2); cont.style.maxHeight=maxH+'px'; cont.style.overflow='auto'; }catch(_){ } };

    // Detalles y modales de lectura
    const showDetailById=(id)=>{ 
      console.log('üîç showDetailById llamado con ID:', id);
      const rec=findById(id); 
      if(!rec){ 
        console.error('‚ùå No se encontr√≥ el registro con ID:', id);
        alert('No se encontr√≥ el registro.'); 
        return; 
      } 
      console.log('‚úÖ Registro encontrado para detalles:', rec);
      const c=document.getElementById('detailContent'); 
      c.innerHTML=''; 
      const fields=[ ['ID',rec['ID']], ['Mes',getMonthName(rec['MONTH(FECHA_EMISION)'])], ['Encargado comprobante', rec['ENCARGADO_COMPROBANTE']], ['Fecha de emisi√≥n', fmtDateDisplay(rec['DATE(FECHA_EMISION)'])], ['N¬∞ proforma/acta', rec['NUMERO_PROFORMA']], ['N¬∞ de comprobante', rec['NUMERO_COMPROBANTE']], ['Tipo de incidencia', rec['TIPO_INCIDENCIA']||''], ['Fecha de notificaci√≥n', fmtDateOnly(rec['FECHA_NOTIFICACION']||'')], ['Soluci√≥n', rec['SOLUCION']||''], ['Obs. adicionales', rec['OBSERVACION_ADICIONAL_CORRECION']||''], ['Revisado por', rec['REVISADO_POR']||''], ['Estado de verificaci√≥n', rec['ESTADO_INCIDENCIA']||''], ['Fecha env√≠o de archivo', fmtDateDisplay(rec['FECHA_ENVIO_ARCHIVO']||'')], ['Fecha de correcci√≥n', fmtDateDisplay(rec['FECHA_CORRECION']||'')], ['Comprobante', rec['COMPROBANTE']||''], ['N¬∞ de comprobante', rec['NUMERO_COMPROBANTE_SOLUCION']||''], ['Estado de soluci√≥n', rec['ESTADO_SOLUCION']||''], ['Culminado', rec['CULMINADO']||'NO'] ]; 
      fields.forEach(([l,v])=>{ const p=document.createElement('p'); const strong=document.createElement('strong'); strong.textContent=l+': '; p.appendChild(strong); p.appendChild(document.createTextNode(v||'')); c.appendChild(p); }); 
      if(rec['ITEMS']&&rec['ITEMS'].length){ const ul=document.createElement('ul'); rec['ITEMS'].forEach((it,i)=>{ const li=document.createElement('li'); li.appendChild(document.createTextNode(`Detalle ${i+1}: ${it['DETALLE DE ERROR']||''}`)); li.appendChild(document.createElement('br')); li.appendChild(document.createTextNode(`Debe ser ${i+1}: ${it['DEBE SER']||''}`)); ul.appendChild(li); }); c.appendChild(ul);} 
      document.getElementById('detailModal').style.display='flex'; 
    };

    const isUrl=(s)=>{ try{ const u=new URL(s); return u.protocol==='http:'||u.protocol==='https:'; }catch{ return false; } };
    const openViewTextModalById=(id)=>{ 
      console.log('üîç openViewTextModalById llamado con ID:', id);
      const rec=findById(id); 
      if(!rec){ 
        console.error('‚ùå No se encontr√≥ el registro con ID:', id);
        alert('No se encontr√≥ el registro.'); 
        return; 
      } 
      console.log('‚úÖ Registro encontrado para archivo:', rec);
      const cont=document.getElementById('viewArchivoContent'); 
      cont.innerHTML=''; 
      const txt=(rec['ARCHIVO_SOLUCION_PDF']||'').trim(); 
      if(!txt){ cont.textContent='(Sin texto/enlace)'; } else if(isUrl(txt)){ const a=document.createElement('a'); a.href=txt; a.target='_blank'; a.textContent=txt; cont.appendChild(a);} else { const pre=document.createElement('div'); pre.className='prelike'; pre.textContent=txt; cont.appendChild(pre);} 
      document.getElementById('viewTextModal').style.display='flex'; 
    };

    // Guardados (Facturaci√≥n) - API calls
    const performEstadoSolucionSave = async (id, {comprobante, numero, estado}) => {
      try {
        console.log('üîÑ Guardando estado de soluci√≥n para ID:', id);
        console.log('üìä Datos a enviar:', {comprobante, numero, estado});
        
        const data = {
          comprobante: comprobante || '',
          numero_comprobante: numero || '',
          estado_solucion: (estado || '').toUpperCase(),
          id: id
        };
        
        const params = {
          metodo: "facturacion"
        };
        
        const result = await apiPut(data, params);
        console.log('üì§ Respuesta de API:', result);
        
        if (result) {
          // Recargar datos despu√©s de actualizar
          await loadRecords();
          console.log('‚úÖ Estado de soluci√≥n guardado exitosamente');
          return true;
        }
        return false;
      } catch (error) {
        console.error('‚ùå Error guardando estado de soluci√≥n:', error);
        return false;
      }
    };

    // Apertura de modales
    let currentEditId=null;
    const openEstadoSolModalById=(id)=>{ 
      console.log('üîç openEstadoSolModalById llamado con ID:', id);
      currentEditId=id; 
      const rec=findById(id); 
      if(!rec){ 
        console.error('‚ùå No se encontr√≥ el registro con ID:', id);
        alert('No se encontr√≥ el registro.'); 
        return; 
      } 
      console.log('‚úÖ Registro encontrado para estado de soluci√≥n:', rec);
      document.getElementById('fTipoComprobante').value=rec['COMPROBANTE']||''; 
      document.getElementById('fNumeroComprobante').value=rec['NUMERO_COMPROBANTE_SOLUCION']||''; 
      const estado=(rec['ESTADO_SOLUCION']||''); 
      const options=['Pendiente','Realizado']; 
      const match=options.find(x=>x.toUpperCase()===(estado||'').toUpperCase()); 
      document.getElementById('fEstadoSolucion').value=match||''; 
      document.getElementById('estadoSolModal').style.display='flex'; 
    };

    // Clicks globales (una sola vez)
    window.addEventListener('load', async ()=>{
      await loadRecords();
      renderList(); 
      adjustTableHeightToRows(10);

      // Acciones tabla (delegaci√≥n)
      document.getElementById('tablaFact').addEventListener('click', (e)=>{
        const t=e.target.closest('a,button'); 
        if(!t) return; 
        const id=t.dataset.id; 
        const action=t.dataset.action; 
        console.log('üñ±Ô∏è Click detectado - ID:', id, 'Action:', action);
        
        if(action==='view'){ e.preventDefault(); showDetailById(id);} 
        if(action==='pdf'){ e.preventDefault(); generatePDFById(id);} 
        if(action==='view-text'){ e.preventDefault(); openViewTextModalById(id);} 
        if(action==='edit-sol'){ e.preventDefault(); openEstadoSolModalById(id);} 
      });

      // Filtros & reportes
      document.getElementById('applyFilter').onclick=()=>renderList();
      document.getElementById('clearFilters').onclick=()=>{ document.getElementById('filterEstado').value='TODOS'; document.getElementById('filterStart').value=''; document.getElementById('filterEnd').value=''; renderList(); };
      document.getElementById('exportCSV').onclick=()=>{ const table=document.getElementById('tablaFact'); const header=[...table.tHead.rows[0].cells].map(th=>`"${th.innerText.replace(/"/g,'""')}"`).join(','); const body=[...table.tBodies[0].rows].map(tr=>[...tr.cells].map(td=>`"${td.innerText.replace(/"/g,'""')}"`).join(',')).join('\n'); const csv=header+'\n'+body; const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='incidencias_facturacion.csv'; a.click(); URL.revokeObjectURL(url); };
      document.getElementById('generateReport').onclick=async()=>{ const table=document.getElementById('tablaFact'); const canvas=await html2canvas(table); const img=canvas.toDataURL('image/png'); const { jsPDF }=window.jspdf; const pdf=new jsPDF({orientation:'landscape'}); const props=pdf.getImageProperties(img); const pdfW=pdf.internal.pageSize.getWidth(); const pdfH=(props.height*pdfW)/props.width; pdf.addImage(img,'PNG',0,10,pdfW,pdfH); pdf.save('reporte_incidencias_facturacion.pdf'); };

      // Procedimiento modal
      document.getElementById('btnProcedimiento').onclick=()=>{ document.getElementById('procedimientoModal').style.display='flex'; };
      document.getElementById('closeProcedimiento').onclick=()=>{ document.getElementById('procedimientoModal').style.display='none'; };

      // Cerrar modales de lectura
      document.getElementById('closeDetail').onclick=()=>{ document.getElementById('detailModal').style.display='none'; };
      document.getElementById('closeViewText').onclick=()=>{ document.getElementById('viewTextModal').style.display='none'; };

      // Guardar modales de edici√≥n
      document.getElementById('saveEstadoSol').onclick=async ()=>{ if(!currentEditId) return; const comprobante=document.getElementById('fTipoComprobante').value; const numero=document.getElementById('fNumeroComprobante').value; const estado=document.getElementById('fEstadoSolucion').value; if(!comprobante && !numero && !estado){ alert('Complete al menos un campo.'); return; } const success=await performEstadoSolucionSave(currentEditId,{comprobante,numero,estado}); if(success){ document.getElementById('estadoSolModal').style.display='none'; renderList(); } else { alert('Error al guardar. Intente nuevamente.'); } };
      document.getElementById('cancelEstadoSol').onclick=()=>{ document.getElementById('estadoSolModal').style.display='none'; };
      document.getElementById('closeEstadoSol').onclick=()=>{ document.getElementById('estadoSolModal').style.display='none'; };

      // Autoajuste al mutar filas
      try{ const tbody=document.querySelector('#tablaFact tbody'); const mo=new MutationObserver(()=>adjustTableHeightToRows(10)); mo.observe(tbody,{childList:true}); window.__factRowsObserver=mo; }catch{}
    });

    window.addEventListener('resize', ()=>adjustTableHeightToRows(10));

    // ====== Pruebas r√°pidas ======
    const runSelfTests=()=>{ console.group('Facturaci√≥n Tests'); console.log('API integrada correctamente'); console.groupEnd(); };
    runSelfTests();

    // ====== PDF por fila ======
    const generatePDFById=(id)=>{ 
      console.log('üîç generatePDFById llamado con ID:', id);
      const rec=findById(id); 
      if(!rec){ 
        console.error('‚ùå No se encontr√≥ el registro con ID:', id);
        alert('No se encontr√≥ el registro.'); 
        return; 
      } 
      console.log('‚úÖ Registro encontrado para PDF:', rec);
      const { jsPDF }=window.jspdf; 
      const doc=new jsPDF(); 
      let y=10; 
      doc.setFontSize(12); 
      const lines=[`ID: ${rec['ID']}`,`Mes: ${getMonthName(rec['MONTH(FECHA_EMISION)'])}`,`Encargado: ${rec['ENCARGADO_COMPROBANTE']}`,`Fecha emisi√≥n: ${fmtDateDisplay(rec['DATE(FECHA_EMISION)'])}`,`N¬∞ proforma/acta: ${rec['NUMERO_PROFORMA']}`,`N¬∞ comprobante: ${rec['NUMERO_COMPROBANTE']}`,`Tipo: ${rec['TIPO_INCIDENCIA']||''}`,`Fecha notificaci√≥n: ${fmtDateDisplay(rec['FECHA_NOTIFICACION'])}`,`Soluci√≥n: ${(rec['SOLUCION']||'')}`,`Obs. adicionales: ${(rec['OBSERVACION_ADICIONAL_CORRECION']||'').toString().replace(/\n/g,' ')}`,`Revisado por: ${rec['REVISADO_POR']||''}`,`Estado verificaci√≥n: ${rec['ESTADO_INCIDENCIA']||''}`,`Fecha env√≠o archivo: ${fmtDateDisplay(rec['FECHA_ENVIO_ARCHIVO']||'')}`,`Fecha correcci√≥n: ${fmtDateDisplay(rec['FECHA_CORRECION']||'')}`,`Comprobante: ${rec['COMPROBANTE']||''}`,`N¬∞ Comprobante: ${rec['NUMERO_COMPROBANTE_SOLUCION']||''}`,`Estado soluci√≥n: ${rec['ESTADO_SOLUCION']||''}`,`Culminado: ${rec['CULMINADO']||'NO'}`,`Fecha concluyente: ${fmtDateDisplay(rec['FECHA_CONCLUYENTE']||'')}` ]; 
      lines.forEach(line=>{ doc.text(line,10,y); y+=7; if(y>280){ doc.addPage(); y=10; } }); 
      doc.save(`${rec['ID']||'incidencia'}.pdf`); 
    };
  </script>
</body>
</html>
